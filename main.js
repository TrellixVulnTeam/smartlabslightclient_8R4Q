var ttn=require('ttn');
var Web3=require('web3');
//check for geth connection
if (typeof web3 !== 'undefined') {
  web3 = new Web3(web3.currentProvider);
} else {
  // set the provider you want from Web3.providers
  web3 = new Web3(new Web3.providers.HttpProvider("http://192.168.1.144:8545"));
  console.log("IPC:coneection established to account "+web3.eth.accounts);
}

ABIarray=[{"constant":true,"inputs":[{"name":"Country","type":"bytes32"}],"name":"showflag","outputs":[{"name":"j","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"index","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"data11","type":"uint16"},{"name":"data12","type":"uint16"},{"name":"data21","type":"uint16"},{"name":"data22","type":"uint16"},{"name":"data31","type":"uint16"},{"name":"data32","type":"uint16"},{"name":"data41","type":"uint16"},{"name":"data42","type":"uint16"}],"name":"updateStandards","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"x11","type":"uint16"},{"name":"x21","type":"uint16"},{"name":"x31","type":"uint16"},{"name":"x41","type":"uint16"}],"name":"compare","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"Country","type":"bytes32"},{"name":"Location","type":"bytes32"},{"name":"deviceID","type":"bytes32"},{"name":"x11","type":"uint16"},{"name":"x21","type":"uint16"},{"name":"x31","type":"uint16"},{"name":"x41","type":"uint16"}],"name":"save","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"Country","type":"bytes32"},{"name":"Location","type":"bytes32"},{"name":"deviceID","type":"bytes32"}],"name":"retrievedata","outputs":[{"name":"x","type":"bytes32"},{"name":"y","type":"uint16"},{"name":"z","type":"uint16"},{"name":"k","type":"uint16"},{"name":"j","type":"uint16"},{"name":"f","type":"bytes32[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"message","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"retrievestandards","outputs":[{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"bytes32"}],"name":"cdata","outputs":[{"name":"flag","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"data","outputs":[{"name":"Country","type":"bytes32"},{"name":"Location","type":"bytes32"},{"name":"deviceID","type":"bytes32"},{"name":"CO","type":"uint16"},{"name":"CO2","type":"uint16"},{"name":"Turbidity","type":"uint16"},{"name":"PH","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}];
contractAddress="0x5cc1490ef1361107043397c0e4d0de944c9cad5b";

bytedata="6060604052341561000f57600080fd5b60096000806101000a81548161ffff021916908361ffff1602179055506023600060026101000a81548161ffff021916908361ffff16021790555060fa600060046101000a81548161ffff021916908361ffff16021790555061015e600060066101000a81548161ffff021916908361ffff16021790555060008060086101000a81548161ffff021916908361ffff16021790555060056000600a6101000a81548161ffff021916908361ffff16021790555060066000600c6101000a81548161ffff021916908361ffff16021790555060096000600e6101000a81548161ffff021916908361ffff160217905550610f638061010d6000396000f3006060604052600436106100a4576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680631b93097a146100a9578063335932fc146100e85780633a81739a1461011f5780635a388f2c146101b957806379b02baf1461021f578063b2166dad146102ac578063d1e8507b1461038d578063db86c5ff146103cc578063edc399b214610466578063f0ba8440146104a5575b600080fd5b34156100b457600080fd5b6100ce60048080356000191690602001909190505061053e565b604051808215151515815260200191505060405180910390f35b34156100f357600080fd5b6101096004808035906020019091905050610573565b6040518082815260200191505060405180910390f35b341561012a57600080fd5b61019f600480803561ffff1690602001909190803561ffff1690602001909190803561ffff1690602001909190803561ffff1690602001909190803561ffff1690602001909190803561ffff1690602001909190803561ffff1690602001909190803561ffff16906020019091905050610597565b604051808215151515815260200191505060405180910390f35b34156101c457600080fd5b610205600480803561ffff1690602001909190803561ffff1690602001909190803561ffff1690602001909190803561ffff16906020019091905050610690565b604051808215151515815260200191505060405180910390f35b341561022a57600080fd5b610292600480803560001916906020019091908035600019169060200190919080356000191690602001909190803561ffff1690602001909190803561ffff1690602001909190803561ffff1690602001909190803561ffff1690602001909190505061094a565b604051808215151515815260200191505060405180910390f35b34156102b757600080fd5b6102eb6004808035600019169060200190919080356000191690602001909190803560001916906020019091905050610b13565b6040518087600019166000191681526020018661ffff1661ffff1681526020018561ffff1661ffff1681526020018461ffff1661ffff1681526020018361ffff1661ffff16815260200180602001828103825283818151815260200191508051906020019060200280838360005b83811015610374578082015181840152602081019050610359565b5050505090500197505050505050505060405180910390f35b341561039857600080fd5b6103ae6004808035906020019091905050610cdf565b60405180826000191660001916815260200191505060405180910390f35b34156103d757600080fd5b6103df610d03565b604051808961ffff1661ffff1681526020018861ffff1661ffff1681526020018761ffff1661ffff1681526020018661ffff1661ffff1681526020018561ffff1661ffff1681526020018461ffff1661ffff1681526020018361ffff1661ffff1681526020018261ffff1661ffff1681526020019850505050505050505060405180910390f35b341561047157600080fd5b61048b600480803560001916906020019091905050610db0565b604051808215151515815260200191505060405180910390f35b34156104b057600080fd5b6104c66004808035906020019091905050610ddb565b604051808860001916600019168152602001876000191660001916815260200186600019166000191681526020018561ffff1661ffff1681526020018461ffff1661ffff1681526020018361ffff1661ffff1681526020018261ffff1661ffff16815260200197505050505050505060405180910390f35b600060036000836000191660001916815260200190815260200160002060000160009054906101000a900460ff169050919050565b60028181548110151561058257fe5b90600052602060002090016000915090505481565b6000886000806101000a81548161ffff021916908361ffff16021790555087600060026101000a81548161ffff021916908361ffff16021790555086600060046101000a81548161ffff021916908361ffff16021790555085600060066101000a81548161ffff021916908361ffff160217905550846000600c6101000a81548161ffff021916908361ffff160217905550836000600e6101000a81548161ffff021916908361ffff16021790555082600060086101000a81548161ffff021916908361ffff160217905550816000600a6101000a81548161ffff021916908361ffff1602179055506001905098975050505050505050565b6000806001905060006001816106a69190610e55565b506000809054906101000a900461ffff1661ffff168661ffff1610806106e35750600060029054906101000a900461ffff1661ffff168661ffff16115b80156106f3575060008661ffff16115b1561074c576001805480600101828161070c9190610e81565b916000526020600020900160007f434f00000000000000000000000000000000000000000000000000000000000090919091509060001916905550600090505b600060049054906101000a900461ffff1661ffff168561ffff1610806107895750600060069054906101000a900461ffff1661ffff168561ffff16115b8015610799575060008561ffff16115b156107f257600180548060010182816107b29190610e81565b916000526020600020900160007f434f32000000000000000000000000000000000000000000000000000000000090919091509060001916905550600090505b600060089054906101000a900461ffff1661ffff168461ffff16108061082f57506000600a9054906101000a900461ffff1661ffff168461ffff16115b801561083f575060008461ffff16115b1561089857600180548060010182816108589190610e81565b916000526020600020900160007f547572626964697479000000000000000000000000000000000000000000000090919091509060001916905550600090505b6000600c9054906101000a900461ffff1661ffff168361ffff1610806108d557506000600e9054906101000a900461ffff1661ffff168361ffff16115b80156108e5575060008361ffff16115b1561093e57600180548060010182816108fe9190610e81565b916000526020600020900160007f504800000000000000000000000000000000000000000000000000000000000090919091509060001916905550600090505b80915050949350505050565b60008061095986868686610690565b90508660046000600280549050815260200190815260200160002060020181600019169055508860046000600280549050815260200190815260200160002060000181600019169055508760046000600280549050815260200190815260200160002060010181600019169055508560046000600280549050815260200190815260200160002060030160006101000a81548161ffff021916908361ffff1602179055508460046000600280549050815260200190815260200160002060030160026101000a81548161ffff021916908361ffff1602179055508360046000600280549050815260200190815260200160002060030160046101000a81548161ffff021916908361ffff1602179055508260046000600280549050815260200190815260200160002060030160066101000a81548161ffff021916908361ffff16021790555080600360008b6000191660001916815260200190815260200160002060000160006101000a81548160ff02191690831515021790555060028054806001018281610ae99190610ead565b91600052602060002090016000600280549050909190915055506001915050979650505050505050565b6000806000806000610b23610ed9565b6000879650600090505b600280549050811015610c5c578960001916600460008381526020019081526020016000206000015460001916148015610b8457508860001916600460008381526020019081526020016000206001015460001916145b8015610bad57508760001916600460008381526020019081526020016000206002015460001916145b15610c4f576004600082815260200190815260200160002060030160009054906101000a900461ffff1695506004600082815260200190815260200160002060030160029054906101000a900461ffff1694506004600082815260200190815260200160002060030160049054906101000a900461ffff1693506004600082815260200190815260200160002060030160069054906101000a900461ffff1692505b8080600101915050610b2d565b610c6886868686610690565b508686868686600180805480602002602001604051908101604052809291908181526020018280548015610cbf57602002820191906000526020600020905b81546000191681526020019060010190808311610ca7575b505050505090509650965096509650965096505093975093979195509350565b600181815481101515610cee57fe5b90600052602060002090016000915090505481565b6000806000806000806000806000809054906101000a900461ffff16600060029054906101000a900461ffff16600060049054906101000a900461ffff16600060069054906101000a900461ffff16600060089054906101000a900461ffff166000600a9054906101000a900461ffff166000600c9054906101000a900461ffff166000600e9054906101000a900461ffff16975097509750975097509750975097509091929394959697565b60036020528060005260406000206000915090508060000160009054906101000a900460ff16905081565b60046020528060005260406000206000915090508060000154908060010154908060020154908060030160009054906101000a900461ffff16908060030160029054906101000a900461ffff16908060030160049054906101000a900461ffff16908060030160069054906101000a900461ffff16905087565b815481835581811511610e7c57818360005260206000209182019101610e7b9190610eed565b5b505050565b815481835581811511610ea857818360005260206000209182019101610ea79190610eed565b5b505050565b815481835581811511610ed457818360005260206000209182019101610ed39190610f12565b5b505050565b602060405190810160405280600081525090565b610f0f91905b80821115610f0b576000816000905550600101610ef3565b5090565b90565b610f3491905b80821115610f30576000816000905550600101610f18565b5090565b905600a165627a7a723058204edceba3284d32afecbf1a211983dd53bedff69a5456b7dde62ac9a45ba59ab80029";

myContract=web3.eth.contract(ABIarray).at(contractAddress);



//TTN packet receving
const appID = "pollutanttracker";
const accessKey = "ttn-account-v2.d8l4oxhnFnTIxJ8htdhU85VKPAjlGMI2YWVNF9591os";
// discover handler and open mqtt connection
ttn.data(appID, accessKey)
  .then(function (client) {
	  console.log("TTN Connection established, waiting for payload");
    client.on("uplink", function (devID, payload) {
      console.log("Received uplink from ", devID);
      console.log(payload.payload_fields);
      console.log(payload.payload_fields.Carbondi);
      console.log(payload.payload_fields.Carbonmono);
      console.log(payload.payload_fields.PHvalue);
      console.log(payload.payload_fields.Turbi);
      
	
      myContract.save.sendTransaction("Switzerland","Zurich","PIMS",
      payload.payload_fields.Carbondi,payload.payload_fields.Carbonmono,payload.payload_fields.Turbi,payload.payload_fields.PHvalue,
      {from:web3.eth.accounts[0], gas:300000},function(err,res){
      console.log("transaction sent is:"+res); 
	
    });
    })
  })
  .catch(function (err) {
    console.error(err);
    process.exit(1);
  })
 
// discover handler and open application manager client
/*application(appID, accessKey)
  .then(function (client) {
    return client.get();
  })
  .then(function (app) {
    console.log("Got app", app);
  })
  .catch(function (err) {
    console.error(err);
    process.exit(1);
  })*/
  
