"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ApplicationClient = undefined;

var _keys = require("babel-runtime/core-js/object/keys");

var _keys2 = _interopRequireDefault(_keys);

var _extends2 = require("babel-runtime/helpers/extends");

var _extends3 = _interopRequireDefault(_extends2);

var _regenerator = require("babel-runtime/regenerator");

var _regenerator2 = _interopRequireDefault(_regenerator);

var _toConsumableArray2 = require("babel-runtime/helpers/toConsumableArray");

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _asyncToGenerator2 = require("babel-runtime/helpers/asyncToGenerator");

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require("babel-runtime/helpers/createClass");

var _createClass3 = _interopRequireDefault(_createClass2);

var _sourceMapSupport2 = require("source-map-support");

var _grpc = require("grpc");

var _grpc2 = _interopRequireDefault(_grpc);

var _handler_pb = require("ttnapi/handler/handler_pb");

var _handler_pb2 = _interopRequireDefault(_handler_pb);

var _device_pb = require("ttnapi/protocol/lorawan/device_pb");

var _device_pb2 = _interopRequireDefault(_device_pb);

var _handler_grpc_pb = require("ttnapi/handler/handler_grpc_pb");

var _handler_grpc_pb2 = _interopRequireDefault(_handler_grpc_pb);

var _utils = require("../utils");

var _isToken = require("../utils/is-token");

var _isToken2 = _interopRequireDefault(_isToken);

var _normalize = require("./normalize");

var _normalize2 = _interopRequireDefault(_normalize);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

(0, _sourceMapSupport2.install)(); // Copyright Â© 2017 The Things Network
// Use of this source code is governed by the MIT license that can be found in the LICENSE file.

// Necessary to make gRPC work
process.env.GRPC_SSL_CIPHER_SUITES = _utils.MODERN_CIPHER_SUITES;

/**
 * A client that manages devices on the handler.
 */

var ApplicationClient = exports.ApplicationClient = function () {

  /**
   * Create and open an application manager client that can be used for
   * retreiving and updating an application and its devices.
   *
   * @param appID - The ID of the application you want to manage
   * @param tokenOrKey - The Access Token or Access Key used to authenticate
   * @param netAddress - The gRPC address of the handler where the application is registered
   * @param certificate - An optional certificate used to connect to the handler securely
   */


  /** @private */


  /** @private */
  function ApplicationClient(appID, tokenOrKey, netAddress, certificate) {
    (0, _classCallCheck3.default)(this, ApplicationClient);

    var credentials = certificate ? _grpc2.default.credentials.createSsl(certificate && new Buffer(certificate)) : _grpc2.default.credentials.createInsecure();

    this.client = new _handler_grpc_pb2.default.ApplicationManagerClient(netAddress, credentials);
    this.appID = appID;

    if ((0, _isToken2.default)(tokenOrKey)) {
      this.appAccessToken = tokenOrKey;
    } else {
      this.appAccessKey = tokenOrKey;
    }
  }

  /** @private */


  /** @private */


  /** @private */


  (0, _createClass3.default)(ApplicationClient, [{
    key: "exec",
    value: function () {
      var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(fn) {
        for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
          args[_key - 1] = arguments[_key];
        }

        var meta, res;
        return _regenerator2.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                meta = new _grpc2.default.Metadata();

                if (this.appAccessToken) {
                  meta.add("token", this.appAccessToken);
                } else if (this.appAccessKey) {
                  meta.add("key", this.appAccessKey);
                }

                _context.next = 4;
                return _utils.wrap.apply(undefined, [this.client, fn].concat((0, _toConsumableArray3.default)(args), [meta]));

              case 4:
                res = _context.sent;
                return _context.abrupt("return", res.toObject());

              case 6:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function exec(_x) {
        return _ref.apply(this, arguments);
      }

      return exec;
    }()

    /**
     * Get the application
     */

  }, {
    key: "get",
    value: function () {
      var _ref2 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee2() {
        var req, app;
        return _regenerator2.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                req = new _handler_pb2.default.ApplicationIdentifier();

                req.setAppId(this.appID);

                _context2.next = 4;
                return this.exec(this.client.getApplication, req);

              case 4:
                app = _context2.sent;

                app.payloadFormat = app.payloadFormat || "custom";

                return _context2.abrupt("return", app);

              case 7:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2, this);
      }));

      function get() {
        return _ref2.apply(this, arguments);
      }

      return get;
    }()

    /**
     * Change the payload format of the application.
     */

  }, {
    key: "setPayloadFormat",
    value: function () {
      var _ref3 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee3(format) {
        return _regenerator2.default.wrap(function _callee3$(_context3) {
          while (1) {
            switch (_context3.prev = _context3.next) {
              case 0:
                _context3.next = 2;
                return this.set({
                  payloadFormat: format
                });

              case 2:
              case "end":
                return _context3.stop();
            }
          }
        }, _callee3, this);
      }));

      function setPayloadFormat(_x2) {
        return _ref3.apply(this, arguments);
      }

      return setPayloadFormat;
    }()

    /**
     * Set the custom payload functions of the application and set the format
     * to custom.
     */

  }, {
    key: "setCustomPayloadFunctions",
    value: function () {
      var _ref4 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee4() {
        var fns = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
        return _regenerator2.default.wrap(function _callee4$(_context4) {
          while (1) {
            switch (_context4.prev = _context4.next) {
              case 0:
                _context4.next = 2;
                return this.set((0, _extends3.default)({
                  payloadFormat: "custom"
                }, fns));

              case 2:
              case "end":
                return _context4.stop();
            }
          }
        }, _callee4, this);
      }));

      function setCustomPayloadFunctions() {
        return _ref4.apply(this, arguments);
      }

      return setCustomPayloadFunctions;
    }()

    /**
     * Set the registerOnJoinAccessKey or remove it.
     */

  }, {
    key: "setRegisterOnJoinAccessKey",
    value: function () {
      var _ref5 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee5(to) {
        return _regenerator2.default.wrap(function _callee5$(_context5) {
          while (1) {
            switch (_context5.prev = _context5.next) {
              case 0:
                _context5.next = 2;
                return this.set({
                  registerOnJoinAccessKey: to
                });

              case 2:
              case "end":
                return _context5.stop();
            }
          }
        }, _callee5, this);
      }));

      function setRegisterOnJoinAccessKey(_x4) {
        return _ref5.apply(this, arguments);
      }

      return setRegisterOnJoinAccessKey;
    }()

    /**
     * Unregister the application from the handler.
     */

  }, {
    key: "unregister",
    value: function () {
      var _ref6 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee6() {
        var req;
        return _regenerator2.default.wrap(function _callee6$(_context6) {
          while (1) {
            switch (_context6.prev = _context6.next) {
              case 0:
                req = new _handler_pb2.default.ApplicationIdentifier();

                req.setAppId(this.appID);
                return _context6.abrupt("return", this.exec(this.client.deleteApplication, req));

              case 3:
              case "end":
                return _context6.stop();
            }
          }
        }, _callee6, this);
      }));

      function unregister() {
        return _ref6.apply(this, arguments);
      }

      return unregister;
    }()

    /** @private */

  }, {
    key: "set",
    value: function () {
      var _ref7 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee7() {
        var updates = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
        var req;
        return _regenerator2.default.wrap(function _callee7$(_context7) {
          while (1) {
            switch (_context7.prev = _context7.next) {
              case 0:
                req = new _handler_pb2.default.Application();


                req.setAppId(this.appID);

                if ("payloadFormat" in updates) {
                  req.setPayloadFormat(updates.payloadFormat);
                }

                if ("registerOnJoinAccessKey" in updates) {
                  req.setRegisterOnJoinAccessKey(updates.registerOnJoinAccessKey);
                }

                if ("decoder" in updates) {
                  req.setDecoder(updates.decoder);
                }

                if ("converter" in updates) {
                  req.setConverter(updates.converter);
                }

                if ("validator" in updates) {
                  req.setValidator(updates.validator);
                }

                if ("encoder" in updates) {
                  req.setEncoder(updates.encoder);
                }

                return _context7.abrupt("return", this.exec(this.client.setApplication, req));

              case 9:
              case "end":
                return _context7.stop();
            }
          }
        }, _callee7, this);
      }));

      function set() {
        return _ref7.apply(this, arguments);
      }

      return set;
    }()

    /**
     * List the devices of the application
     */

  }, {
    key: "devices",
    value: function () {
      var _ref8 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee8() {
        var req, res;
        return _regenerator2.default.wrap(function _callee8$(_context8) {
          while (1) {
            switch (_context8.prev = _context8.next) {
              case 0:
                req = new _handler_pb2.default.ApplicationIdentifier();

                req.setAppId(this.appID);
                _context8.next = 4;
                return this.exec(this.client.getDevicesForApplication, req);

              case 4:
                res = _context8.sent;
                return _context8.abrupt("return", res.devicesList.map(_normalize2.default));

              case 6:
              case "end":
                return _context8.stop();
            }
          }
        }, _callee8, this);
      }));

      function devices() {
        return _ref8.apply(this, arguments);
      }

      return devices;
    }()

    /**
     * Register a device in the application.
     */

  }, {
    key: "registerDevice",
    value: function () {
      var _ref9 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee9(devID, device) {
        return _regenerator2.default.wrap(function _callee9$(_context9) {
          while (1) {
            switch (_context9.prev = _context9.next) {
              case 0:
                return _context9.abrupt("return", this.setDevice(devID, device));

              case 1:
              case "end":
                return _context9.stop();
            }
          }
        }, _callee9, this);
      }));

      function registerDevice(_x6, _x7) {
        return _ref9.apply(this, arguments);
      }

      return registerDevice;
    }()

    /**
     * Get the device specified by the devID
     */

  }, {
    key: "device",
    value: function () {
      var _ref10 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee10(devID) {
        var req, res;
        return _regenerator2.default.wrap(function _callee10$(_context10) {
          while (1) {
            switch (_context10.prev = _context10.next) {
              case 0:
                req = new _handler_pb2.default.DeviceIdentifier();

                req.setAppId(this.appID);
                req.setDevId(devID);
                _context10.next = 5;
                return this.exec(this.client.getDevice, req);

              case 5:
                res = _context10.sent;
                return _context10.abrupt("return", (0, _normalize2.default)(res));

              case 7:
              case "end":
                return _context10.stop();
            }
          }
        }, _callee10, this);
      }));

      function device(_x8) {
        return _ref10.apply(this, arguments);
      }

      return device;
    }()

    /** @private */

  }, {
    key: "setDevice",
    value: function () {
      var _ref11 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee11(devID, device) {
        var req;
        return _regenerator2.default.wrap(function _callee11$(_context11) {
          while (1) {
            switch (_context11.prev = _context11.next) {
              case 0:
                req = this.deviceRequest(devID, device);
                return _context11.abrupt("return", this.exec(this.client.setDevice, req));

              case 2:
              case "end":
                return _context11.stop();
            }
          }
        }, _callee11, this);
      }));

      function setDevice(_x9, _x10) {
        return _ref11.apply(this, arguments);
      }

      return setDevice;
    }()

    /**
     * Update the device specified by the devID with the specified updates
     */

  }, {
    key: "updateDevice",
    value: function () {
      var _ref12 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee12(devID, updates) {
        var device, req;
        return _regenerator2.default.wrap(function _callee12$(_context12) {
          while (1) {
            switch (_context12.prev = _context12.next) {
              case 0:
                _context12.next = 2;
                return this.device(devID);

              case 2:
                device = _context12.sent;
                req = this.deviceRequest(devID, (0, _extends3.default)({}, device, updates));
                return _context12.abrupt("return", this.exec(this.client.setDevice, req));

              case 5:
              case "end":
                return _context12.stop();
            }
          }
        }, _callee12, this);
      }));

      function updateDevice(_x11, _x12) {
        return _ref12.apply(this, arguments);
      }

      return updateDevice;
    }()

    /**
     * Delete the specified device.
     */

  }, {
    key: "deleteDevice",
    value: function () {
      var _ref13 = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee13(devID) {
        var req;
        return _regenerator2.default.wrap(function _callee13$(_context13) {
          while (1) {
            switch (_context13.prev = _context13.next) {
              case 0:
                req = new _handler_pb2.default.DeviceIdentifier();

                req.setAppId(this.appID);
                req.setDevId(devID);
                return _context13.abrupt("return", this.exec(this.client.deleteDevice, req));

              case 4:
              case "end":
                return _context13.stop();
            }
          }
        }, _callee13, this);
      }));

      function deleteDevice(_x13) {
        return _ref13.apply(this, arguments);
      }

      return deleteDevice;
    }()

    /** @private */

  }, {
    key: "deviceRequest",
    value: function deviceRequest(devID) {
      var device = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      var req = new _handler_pb2.default.Device();
      req.setAppId(this.appID);
      req.setDevId(devID);

      if ("description" in device) {
        req.setDescription(device.description);
      }

      if ("latitude" in device) {
        req.setLatitude(device.latitude);
      }

      if ("longitude" in device) {
        req.setLongitude(device.longitude);
      }

      if ("altitude" in device) {
        req.setAltitude(device.altitude);
      }

      if ("attributes" in device) {
        (0, _keys2.default)(device.attributes).forEach(function (key) {
          req.getAttributesMap().set(key, device.attributes[key]);
        });
      }

      req.setLorawanDevice(this.lorawanDeviceRequest(devID, device));

      return req;
    }

    /** @private */

  }, {
    key: "lorawanDeviceRequest",
    value: function lorawanDeviceRequest(devID) {
      var device = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

      var req = new _device_pb2.default.Device();

      req.setAppId(this.appID);
      req.setDevId(devID);

      if ("appEui" in device) {
        req.setAppEui(new Uint8Array(new Buffer(device.appEui, "hex")));
      }

      if ("devEui" in device) {
        req.setDevEui(new Uint8Array(new Buffer(device.devEui, "hex")));
      }

      if ("devAddr" in device) {
        req.setDevAddr(new Uint8Array(new Buffer(device.devAddr, "hex")));
      }

      if ("nwkSKey" in device) {
        req.setNwkSKey(new Uint8Array(new Buffer(device.nwkSKey, "hex")));
      }

      if ("appSKey" in device) {
        req.setAppSKey(new Uint8Array(new Buffer(device.appSKey, "hex")));
      }

      if ("appKey" in device) {
        req.setAppKey(new Uint8Array(new Buffer(device.appKey, "hex")));
      }

      if ("fCntUp" in device) {
        req.setFCntUp(device.fCntUp);
      }

      if ("fCntDown" in device) {
        req.setFCntDown(device.fCntDown);
      }

      if ("disableFCntCheck" in device) {
        req.setDisableFCntCheck(device.disableFCntCheck);
      }

      if ("uses32BitFCnt" in device) {
        req.setUses32BitFCnt(device.uses32BitFCnt);
      }

      return req;
    }
  }]);
  return ApplicationClient;
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hcHBsaWNhdGlvbnMvYXBwbGljYXRpb25zLmpzIl0sIm5hbWVzIjpbInByb2Nlc3MiLCJlbnYiLCJHUlBDX1NTTF9DSVBIRVJfU1VJVEVTIiwiQXBwbGljYXRpb25DbGllbnQiLCJhcHBJRCIsInRva2VuT3JLZXkiLCJuZXRBZGRyZXNzIiwiY2VydGlmaWNhdGUiLCJjcmVkZW50aWFscyIsImNyZWF0ZVNzbCIsIkJ1ZmZlciIsImNyZWF0ZUluc2VjdXJlIiwiY2xpZW50IiwiQXBwbGljYXRpb25NYW5hZ2VyQ2xpZW50IiwiYXBwQWNjZXNzVG9rZW4iLCJhcHBBY2Nlc3NLZXkiLCJmbiIsImFyZ3MiLCJtZXRhIiwiTWV0YWRhdGEiLCJhZGQiLCJyZXMiLCJ0b09iamVjdCIsInJlcSIsIkFwcGxpY2F0aW9uSWRlbnRpZmllciIsInNldEFwcElkIiwiZXhlYyIsImdldEFwcGxpY2F0aW9uIiwiYXBwIiwicGF5bG9hZEZvcm1hdCIsImZvcm1hdCIsInNldCIsImZucyIsInRvIiwicmVnaXN0ZXJPbkpvaW5BY2Nlc3NLZXkiLCJkZWxldGVBcHBsaWNhdGlvbiIsInVwZGF0ZXMiLCJBcHBsaWNhdGlvbiIsInNldFBheWxvYWRGb3JtYXQiLCJzZXRSZWdpc3Rlck9uSm9pbkFjY2Vzc0tleSIsInNldERlY29kZXIiLCJkZWNvZGVyIiwic2V0Q29udmVydGVyIiwiY29udmVydGVyIiwic2V0VmFsaWRhdG9yIiwidmFsaWRhdG9yIiwic2V0RW5jb2RlciIsImVuY29kZXIiLCJzZXRBcHBsaWNhdGlvbiIsImdldERldmljZXNGb3JBcHBsaWNhdGlvbiIsImRldmljZXNMaXN0IiwibWFwIiwiZGV2SUQiLCJkZXZpY2UiLCJzZXREZXZpY2UiLCJEZXZpY2VJZGVudGlmaWVyIiwic2V0RGV2SWQiLCJnZXREZXZpY2UiLCJkZXZpY2VSZXF1ZXN0IiwiZGVsZXRlRGV2aWNlIiwiRGV2aWNlIiwic2V0RGVzY3JpcHRpb24iLCJkZXNjcmlwdGlvbiIsInNldExhdGl0dWRlIiwibGF0aXR1ZGUiLCJzZXRMb25naXR1ZGUiLCJsb25naXR1ZGUiLCJzZXRBbHRpdHVkZSIsImFsdGl0dWRlIiwiYXR0cmlidXRlcyIsImZvckVhY2giLCJrZXkiLCJnZXRBdHRyaWJ1dGVzTWFwIiwic2V0TG9yYXdhbkRldmljZSIsImxvcmF3YW5EZXZpY2VSZXF1ZXN0Iiwic2V0QXBwRXVpIiwiVWludDhBcnJheSIsImFwcEV1aSIsInNldERldkV1aSIsImRldkV1aSIsInNldERldkFkZHIiLCJkZXZBZGRyIiwic2V0TndrU0tleSIsIm53a1NLZXkiLCJzZXRBcHBTS2V5IiwiYXBwU0tleSIsInNldEFwcEtleSIsImFwcEtleSIsInNldEZDbnRVcCIsImZDbnRVcCIsInNldEZDbnREb3duIiwiZkNudERvd24iLCJzZXREaXNhYmxlRkNudENoZWNrIiwiZGlzYWJsZUZDbnRDaGVjayIsInNldFVzZXMzMkJpdEZDbnQiLCJ1c2VzMzJCaXRGQ250Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBS0E7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFFQTs7QUFDQTs7OztBQUVBOzs7Ozs7bUNBZEE7QUFDQTs7QUFpQkE7QUFDQUEsUUFBUUMsR0FBUixDQUFZQyxzQkFBWjs7QUFFQTs7OztJQUdhQyxpQixXQUFBQSxpQjs7QUFjWDs7Ozs7Ozs7Ozs7QUFOQTs7O0FBTkE7QUFxQkEsNkJBQWFDLEtBQWIsRUFBNkJDLFVBQTdCLEVBQWtEQyxVQUFsRCxFQUF1RUMsV0FBdkUsRUFBZ0g7QUFBQTs7QUFDOUcsUUFBTUMsY0FDSkQsY0FDSSxlQUFLQyxXQUFMLENBQWlCQyxTQUFqQixDQUEyQkYsZUFBZSxJQUFJRyxNQUFKLENBQVdILFdBQVgsQ0FBMUMsQ0FESixHQUVJLGVBQUtDLFdBQUwsQ0FBaUJHLGNBQWpCLEVBSE47O0FBS0EsU0FBS0MsTUFBTCxHQUFjLElBQUksMEJBQVFDLHdCQUFaLENBQXFDUCxVQUFyQyxFQUFpREUsV0FBakQsQ0FBZDtBQUNBLFNBQUtKLEtBQUwsR0FBYUEsS0FBYjs7QUFFQSxRQUFJLHVCQUFRQyxVQUFSLENBQUosRUFBeUI7QUFDdkIsV0FBS1MsY0FBTCxHQUFzQlQsVUFBdEI7QUFDRCxLQUZELE1BRU87QUFDTCxXQUFLVSxZQUFMLEdBQW9CVixVQUFwQjtBQUNEO0FBQ0Y7O0FBRUQ7OztBQTVCQTs7O0FBTkE7Ozs7Ozs2RkFtQ1lXLEU7MENBQWtCQyxJO0FBQUFBLGM7Ozs7Ozs7O0FBQ3RCQyxvQixHQUFPLElBQUksZUFBS0MsUUFBVCxFOztBQUNiLG9CQUFJLEtBQUtMLGNBQVQsRUFBeUI7QUFDdkJJLHVCQUFLRSxHQUFMLENBQVMsT0FBVCxFQUFrQixLQUFLTixjQUF2QjtBQUNELGlCQUZELE1BRU8sSUFBSSxLQUFLQyxZQUFULEVBQXVCO0FBQzVCRyx1QkFBS0UsR0FBTCxDQUFTLEtBQVQsRUFBZ0IsS0FBS0wsWUFBckI7QUFDRDs7O3VCQUVpQiw4QkFBSyxLQUFLSCxNQUFWLEVBQWtCSSxFQUFsQiwwQ0FBeUJDLElBQXpCLElBQStCQyxJQUEvQixHOzs7QUFBWkcsbUI7aURBRUNBLElBQUlDLFFBQUosRTs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHVDs7Ozs7Ozs7Ozs7OztBQUlRQyxtQixHQUFNLElBQUkscUJBQU1DLHFCQUFWLEU7O0FBQ1pELG9CQUFJRSxRQUFKLENBQWEsS0FBS3JCLEtBQWxCOzs7dUJBRWtCLEtBQUtzQixJQUFMLENBQVUsS0FBS2QsTUFBTCxDQUFZZSxjQUF0QixFQUFzQ0osR0FBdEMsQzs7O0FBQVpLLG1COztBQUNOQSxvQkFBSUMsYUFBSixHQUFvQkQsSUFBSUMsYUFBSixJQUFxQixRQUF6Qzs7a0RBRU9ELEc7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR1Q7Ozs7Ozs7K0ZBR3dCRSxNOzs7Ozs7dUJBQ2hCLEtBQUtDLEdBQUwsQ0FBUztBQUNiRixpQ0FBZUM7QUFERixpQkFBVCxDOzs7Ozs7Ozs7Ozs7Ozs7OztBQUtSOzs7Ozs7Ozs7WUFJaUNFLEcsdUVBQXlCLEU7Ozs7Ozt1QkFDbEQsS0FBS0QsR0FBTDtBQUNKRixpQ0FBZTtBQURYLG1CQUVERyxHQUZDLEU7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBTVI7Ozs7Ozs7K0ZBR2tDQyxFOzs7Ozs7dUJBQzFCLEtBQUtGLEdBQUwsQ0FBUztBQUNiRywyQ0FBeUJEO0FBRFosaUJBQVQsQzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFLUjs7Ozs7Ozs7Ozs7OztBQUlRVixtQixHQUFNLElBQUkscUJBQU1DLHFCQUFWLEU7O0FBQ1pELG9CQUFJRSxRQUFKLENBQWEsS0FBS3JCLEtBQWxCO2tEQUNPLEtBQUtzQixJQUFMLENBQVUsS0FBS2QsTUFBTCxDQUFZdUIsaUJBQXRCLEVBQXlDWixHQUF6QyxDOzs7Ozs7Ozs7Ozs7Ozs7OztBQUdUOzs7Ozs7WUFDV2EsTyx1RUFBK0IsRTs7Ozs7O0FBQ2xDYixtQixHQUFNLElBQUkscUJBQU1jLFdBQVYsRTs7O0FBRVpkLG9CQUFJRSxRQUFKLENBQWEsS0FBS3JCLEtBQWxCOztBQUVBLG9CQUFJLG1CQUFtQmdDLE9BQXZCLEVBQWdDO0FBQzlCYixzQkFBSWUsZ0JBQUosQ0FBcUJGLFFBQVFQLGFBQTdCO0FBQ0Q7O0FBRUQsb0JBQUksNkJBQTZCTyxPQUFqQyxFQUEwQztBQUN4Q2Isc0JBQUlnQiwwQkFBSixDQUErQkgsUUFBUUYsdUJBQXZDO0FBQ0Q7O0FBRUQsb0JBQUksYUFBYUUsT0FBakIsRUFBMEI7QUFDeEJiLHNCQUFJaUIsVUFBSixDQUFlSixRQUFRSyxPQUF2QjtBQUNEOztBQUVELG9CQUFJLGVBQWVMLE9BQW5CLEVBQTRCO0FBQzFCYixzQkFBSW1CLFlBQUosQ0FBaUJOLFFBQVFPLFNBQXpCO0FBQ0Q7O0FBRUQsb0JBQUksZUFBZVAsT0FBbkIsRUFBNEI7QUFDMUJiLHNCQUFJcUIsWUFBSixDQUFpQlIsUUFBUVMsU0FBekI7QUFDRDs7QUFFRCxvQkFBSSxhQUFhVCxPQUFqQixFQUEwQjtBQUN4QmIsc0JBQUl1QixVQUFKLENBQWVWLFFBQVFXLE9BQXZCO0FBQ0Q7O2tEQUVNLEtBQUtyQixJQUFMLENBQVUsS0FBS2QsTUFBTCxDQUFZb0MsY0FBdEIsRUFBc0N6QixHQUF0QyxDOzs7Ozs7Ozs7Ozs7Ozs7OztBQUdUOzs7Ozs7Ozs7Ozs7O0FBSVFBLG1CLEdBQU0sSUFBSSxxQkFBTUMscUJBQVYsRTs7QUFDWkQsb0JBQUlFLFFBQUosQ0FBYSxLQUFLckIsS0FBbEI7O3VCQUNrQixLQUFLc0IsSUFBTCxDQUFVLEtBQUtkLE1BQUwsQ0FBWXFDLHdCQUF0QixFQUFnRDFCLEdBQWhELEM7OztBQUFaRixtQjtrREFDQ0EsSUFBSTZCLFdBQUosQ0FBZ0JDLEdBQWhCLHFCOzs7Ozs7Ozs7Ozs7Ozs7OztBQUdUOzs7Ozs7OytGQUdzQkMsSyxFQUFnQkMsTTs7Ozs7a0RBQzdCLEtBQUtDLFNBQUwsQ0FBZUYsS0FBZixFQUFzQkMsTUFBdEIsQzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHVDs7Ozs7OztpR0FHY0QsSzs7Ozs7O0FBQ043QixtQixHQUFNLElBQUkscUJBQU1nQyxnQkFBVixFOztBQUNaaEMsb0JBQUlFLFFBQUosQ0FBYSxLQUFLckIsS0FBbEI7QUFDQW1CLG9CQUFJaUMsUUFBSixDQUFhSixLQUFiOzt1QkFDa0IsS0FBSzFCLElBQUwsQ0FBVSxLQUFLZCxNQUFMLENBQVk2QyxTQUF0QixFQUFpQ2xDLEdBQWpDLEM7OztBQUFaRixtQjttREFDQyx5QkFBVUEsR0FBVixDOzs7Ozs7Ozs7Ozs7Ozs7OztBQUdUOzs7OztpR0FDaUIrQixLLEVBQWdCQyxNOzs7Ozs7QUFDekI5QixtQixHQUFNLEtBQUttQyxhQUFMLENBQW1CTixLQUFuQixFQUEwQkMsTUFBMUIsQzttREFDTCxLQUFLM0IsSUFBTCxDQUFVLEtBQUtkLE1BQUwsQ0FBWTBDLFNBQXRCLEVBQWlDL0IsR0FBakMsQzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHVDs7Ozs7OztpR0FHb0I2QixLLEVBQWdCaEIsTzs7Ozs7Ozt1QkFDYixLQUFLaUIsTUFBTCxDQUFZRCxLQUFaLEM7OztBQUFmQyxzQjtBQUNBOUIsbUIsR0FBTSxLQUFLbUMsYUFBTCxDQUFtQk4sS0FBbkIsNkJBQStCQyxNQUEvQixFQUEwQ2pCLE9BQTFDLEU7bURBQ0wsS0FBS1YsSUFBTCxDQUFVLEtBQUtkLE1BQUwsQ0FBWTBDLFNBQXRCLEVBQWlDL0IsR0FBakMsQzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFHVDs7Ozs7OztpR0FHb0I2QixLOzs7Ozs7QUFDWjdCLG1CLEdBQU0sSUFBSSxxQkFBTWdDLGdCQUFWLEU7O0FBQ1poQyxvQkFBSUUsUUFBSixDQUFhLEtBQUtyQixLQUFsQjtBQUNBbUIsb0JBQUlpQyxRQUFKLENBQWFKLEtBQWI7bURBQ08sS0FBSzFCLElBQUwsQ0FBVSxLQUFLZCxNQUFMLENBQVkrQyxZQUF0QixFQUFvQ3BDLEdBQXBDLEM7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBR1Q7Ozs7a0NBQ2U2QixLLEVBQW1EO0FBQUEsVUFBbkNDLE1BQW1DLHVFQUFWLEVBQVU7O0FBQ2hFLFVBQU05QixNQUFNLElBQUkscUJBQU1xQyxNQUFWLEVBQVo7QUFDQXJDLFVBQUlFLFFBQUosQ0FBYSxLQUFLckIsS0FBbEI7QUFDQW1CLFVBQUlpQyxRQUFKLENBQWFKLEtBQWI7O0FBRUEsVUFBSSxpQkFBaUJDLE1BQXJCLEVBQTZCO0FBQzNCOUIsWUFBSXNDLGNBQUosQ0FBbUJSLE9BQU9TLFdBQTFCO0FBQ0Q7O0FBRUQsVUFBSSxjQUFjVCxNQUFsQixFQUEwQjtBQUN4QjlCLFlBQUl3QyxXQUFKLENBQWdCVixPQUFPVyxRQUF2QjtBQUNEOztBQUVELFVBQUksZUFBZVgsTUFBbkIsRUFBMkI7QUFDekI5QixZQUFJMEMsWUFBSixDQUFpQlosT0FBT2EsU0FBeEI7QUFDRDs7QUFFRCxVQUFJLGNBQWNiLE1BQWxCLEVBQTBCO0FBQ3hCOUIsWUFBSTRDLFdBQUosQ0FBZ0JkLE9BQU9lLFFBQXZCO0FBQ0Q7O0FBRUQsVUFBSSxnQkFBZ0JmLE1BQXBCLEVBQTRCO0FBQzFCLDRCQUFZQSxPQUFPZ0IsVUFBbkIsRUFBK0JDLE9BQS9CLENBQXVDLFVBQVVDLEdBQVYsRUFBZTtBQUNwRGhELGNBQUlpRCxnQkFBSixHQUF1QnpDLEdBQXZCLENBQTJCd0MsR0FBM0IsRUFBZ0NsQixPQUFPZ0IsVUFBUCxDQUFrQkUsR0FBbEIsQ0FBaEM7QUFDRCxTQUZEO0FBR0Q7O0FBRURoRCxVQUFJa0QsZ0JBQUosQ0FBcUIsS0FBS0Msb0JBQUwsQ0FBMEJ0QixLQUExQixFQUFpQ0MsTUFBakMsQ0FBckI7O0FBRUEsYUFBTzlCLEdBQVA7QUFDRDs7QUFFRDs7Ozt5Q0FDc0I2QixLLEVBQTBEO0FBQUEsVUFBMUNDLE1BQTBDLHVFQUFWLEVBQVU7O0FBQzlFLFVBQU05QixNQUFNLElBQUksb0JBQVFxQyxNQUFaLEVBQVo7O0FBRUFyQyxVQUFJRSxRQUFKLENBQWEsS0FBS3JCLEtBQWxCO0FBQ0FtQixVQUFJaUMsUUFBSixDQUFhSixLQUFiOztBQUVBLFVBQUksWUFBWUMsTUFBaEIsRUFBd0I7QUFDdEI5QixZQUFJb0QsU0FBSixDQUFjLElBQUlDLFVBQUosQ0FBZSxJQUFJbEUsTUFBSixDQUFXMkMsT0FBT3dCLE1BQWxCLEVBQTBCLEtBQTFCLENBQWYsQ0FBZDtBQUNEOztBQUVELFVBQUksWUFBWXhCLE1BQWhCLEVBQXdCO0FBQ3RCOUIsWUFBSXVELFNBQUosQ0FBYyxJQUFJRixVQUFKLENBQWUsSUFBSWxFLE1BQUosQ0FBVzJDLE9BQU8wQixNQUFsQixFQUEwQixLQUExQixDQUFmLENBQWQ7QUFDRDs7QUFFRCxVQUFJLGFBQWExQixNQUFqQixFQUF5QjtBQUN2QjlCLFlBQUl5RCxVQUFKLENBQWUsSUFBSUosVUFBSixDQUFlLElBQUlsRSxNQUFKLENBQVcyQyxPQUFPNEIsT0FBbEIsRUFBMkIsS0FBM0IsQ0FBZixDQUFmO0FBQ0Q7O0FBRUQsVUFBSSxhQUFhNUIsTUFBakIsRUFBeUI7QUFDdkI5QixZQUFJMkQsVUFBSixDQUFlLElBQUlOLFVBQUosQ0FBZSxJQUFJbEUsTUFBSixDQUFXMkMsT0FBTzhCLE9BQWxCLEVBQTJCLEtBQTNCLENBQWYsQ0FBZjtBQUNEOztBQUVELFVBQUksYUFBYTlCLE1BQWpCLEVBQXlCO0FBQ3ZCOUIsWUFBSTZELFVBQUosQ0FBZSxJQUFJUixVQUFKLENBQWUsSUFBSWxFLE1BQUosQ0FBVzJDLE9BQU9nQyxPQUFsQixFQUEyQixLQUEzQixDQUFmLENBQWY7QUFDRDs7QUFFRCxVQUFJLFlBQVloQyxNQUFoQixFQUF3QjtBQUN0QjlCLFlBQUkrRCxTQUFKLENBQWMsSUFBSVYsVUFBSixDQUFlLElBQUlsRSxNQUFKLENBQVcyQyxPQUFPa0MsTUFBbEIsRUFBMEIsS0FBMUIsQ0FBZixDQUFkO0FBQ0Q7O0FBRUQsVUFBSSxZQUFZbEMsTUFBaEIsRUFBd0I7QUFDdEI5QixZQUFJaUUsU0FBSixDQUFjbkMsT0FBT29DLE1BQXJCO0FBQ0Q7O0FBRUQsVUFBSSxjQUFjcEMsTUFBbEIsRUFBMEI7QUFDeEI5QixZQUFJbUUsV0FBSixDQUFnQnJDLE9BQU9zQyxRQUF2QjtBQUNEOztBQUVELFVBQUksc0JBQXNCdEMsTUFBMUIsRUFBa0M7QUFDaEM5QixZQUFJcUUsbUJBQUosQ0FBd0J2QyxPQUFPd0MsZ0JBQS9CO0FBQ0Q7O0FBRUQsVUFBSSxtQkFBbUJ4QyxNQUF2QixFQUErQjtBQUM3QjlCLFlBQUl1RSxnQkFBSixDQUFxQnpDLE9BQU8wQyxhQUE1QjtBQUNEOztBQUVELGFBQU94RSxHQUFQO0FBQ0QiLCJmaWxlIjoiYXBwbGljYXRpb25zLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IMKpIDIwMTcgVGhlIFRoaW5ncyBOZXR3b3JrXG4vLyBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSB0aGUgTUlUIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS5cblxuLy8gQGZsb3dcblxuaW1wb3J0IGdycGMgZnJvbSBcImdycGNcIlxuXG5pbXBvcnQgcHJvdG8gZnJvbSBcInR0bmFwaS9oYW5kbGVyL2hhbmRsZXJfcGJcIlxuaW1wb3J0IGxvcmF3YW4gZnJvbSBcInR0bmFwaS9wcm90b2NvbC9sb3Jhd2FuL2RldmljZV9wYlwiXG5pbXBvcnQgaGFuZGxlciBmcm9tIFwidHRuYXBpL2hhbmRsZXIvaGFuZGxlcl9ncnBjX3BiXCJcblxuaW1wb3J0IHsgd3JhcCwgTU9ERVJOX0NJUEhFUl9TVUlURVMgfSBmcm9tIFwiLi4vdXRpbHNcIlxuaW1wb3J0IGlzVG9rZW4gZnJvbSBcIi4uL3V0aWxzL2lzLXRva2VuXCJcblxuaW1wb3J0IG5vcm1hbGl6ZSBmcm9tIFwiLi9ub3JtYWxpemVcIlxuXG5pbXBvcnQgdHlwZSB7IERldmljZSwgQXBwbGljYXRpb24sIEFwcGxpY2F0aW9uVXBkYXRlcywgUGF5bG9hZEZ1bmN0aW9ucywgRGV2aWNlVXBkYXRlcywgTG9yYXdhbkRldmljZVVwZGF0ZXMsIFBheWxvYWRGb3JtYXQgfSBmcm9tIFwiLi90eXBlc1wiXG5cbi8vIE5lY2Vzc2FyeSB0byBtYWtlIGdSUEMgd29ya1xucHJvY2Vzcy5lbnYuR1JQQ19TU0xfQ0lQSEVSX1NVSVRFUyA9IE1PREVSTl9DSVBIRVJfU1VJVEVTXG5cbi8qKlxuICogQSBjbGllbnQgdGhhdCBtYW5hZ2VzIGRldmljZXMgb24gdGhlIGhhbmRsZXIuXG4gKi9cbmV4cG9ydCBjbGFzcyBBcHBsaWNhdGlvbkNsaWVudCB7XG5cbiAgLyoqIEBwcml2YXRlICovXG4gIGFwcElEIDogc3RyaW5nXG5cbiAgLyoqIEBwcml2YXRlICovXG4gIGFwcEFjY2Vzc0tleSA6ID9zdHJpbmdcblxuICAvKiogQHByaXZhdGUgKi9cbiAgYXBwQWNjZXNzVG9rZW4gOiA/c3RyaW5nXG5cbiAgLyoqIEBwcml2YXRlICovXG4gIGNsaWVudCA6IGFueVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYW5kIG9wZW4gYW4gYXBwbGljYXRpb24gbWFuYWdlciBjbGllbnQgdGhhdCBjYW4gYmUgdXNlZCBmb3JcbiAgICogcmV0cmVpdmluZyBhbmQgdXBkYXRpbmcgYW4gYXBwbGljYXRpb24gYW5kIGl0cyBkZXZpY2VzLlxuICAgKlxuICAgKiBAcGFyYW0gYXBwSUQgLSBUaGUgSUQgb2YgdGhlIGFwcGxpY2F0aW9uIHlvdSB3YW50IHRvIG1hbmFnZVxuICAgKiBAcGFyYW0gdG9rZW5PcktleSAtIFRoZSBBY2Nlc3MgVG9rZW4gb3IgQWNjZXNzIEtleSB1c2VkIHRvIGF1dGhlbnRpY2F0ZVxuICAgKiBAcGFyYW0gbmV0QWRkcmVzcyAtIFRoZSBnUlBDIGFkZHJlc3Mgb2YgdGhlIGhhbmRsZXIgd2hlcmUgdGhlIGFwcGxpY2F0aW9uIGlzIHJlZ2lzdGVyZWRcbiAgICogQHBhcmFtIGNlcnRpZmljYXRlIC0gQW4gb3B0aW9uYWwgY2VydGlmaWNhdGUgdXNlZCB0byBjb25uZWN0IHRvIHRoZSBoYW5kbGVyIHNlY3VyZWx5XG4gICAqL1xuICBjb25zdHJ1Y3RvciAoYXBwSUQgOiBzdHJpbmcsIHRva2VuT3JLZXkgOiBzdHJpbmcsIG5ldEFkZHJlc3MgOiBzdHJpbmcsIGNlcnRpZmljYXRlIDogPyhCdWZmZXIgfCBzdHJpbmcpKSA6IHZvaWQge1xuICAgIGNvbnN0IGNyZWRlbnRpYWxzID1cbiAgICAgIGNlcnRpZmljYXRlXG4gICAgICAgID8gZ3JwYy5jcmVkZW50aWFscy5jcmVhdGVTc2woY2VydGlmaWNhdGUgJiYgbmV3IEJ1ZmZlcihjZXJ0aWZpY2F0ZSkpXG4gICAgICAgIDogZ3JwYy5jcmVkZW50aWFscy5jcmVhdGVJbnNlY3VyZSgpXG5cbiAgICB0aGlzLmNsaWVudCA9IG5ldyBoYW5kbGVyLkFwcGxpY2F0aW9uTWFuYWdlckNsaWVudChuZXRBZGRyZXNzLCBjcmVkZW50aWFscylcbiAgICB0aGlzLmFwcElEID0gYXBwSURcblxuICAgIGlmIChpc1Rva2VuKHRva2VuT3JLZXkpKSB7XG4gICAgICB0aGlzLmFwcEFjY2Vzc1Rva2VuID0gdG9rZW5PcktleVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmFwcEFjY2Vzc0tleSA9IHRva2VuT3JLZXlcbiAgICB9XG4gIH1cblxuICAvKiogQHByaXZhdGUgKi9cbiAgYXN5bmMgZXhlYyAoZm4gOiBGdW5jdGlvbiwgLi4uYXJncyA6IGFueVtdKSA6IFByb21pc2U8Kj4ge1xuICAgIGNvbnN0IG1ldGEgPSBuZXcgZ3JwYy5NZXRhZGF0YSgpXG4gICAgaWYgKHRoaXMuYXBwQWNjZXNzVG9rZW4pIHtcbiAgICAgIG1ldGEuYWRkKFwidG9rZW5cIiwgdGhpcy5hcHBBY2Nlc3NUb2tlbilcbiAgICB9IGVsc2UgaWYgKHRoaXMuYXBwQWNjZXNzS2V5KSB7XG4gICAgICBtZXRhLmFkZChcImtleVwiLCB0aGlzLmFwcEFjY2Vzc0tleSlcbiAgICB9XG5cbiAgICBjb25zdCByZXMgPSBhd2FpdCB3cmFwKHRoaXMuY2xpZW50LCBmbiwgLi4uYXJncywgbWV0YSlcblxuICAgIHJldHVybiByZXMudG9PYmplY3QoKVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgYXBwbGljYXRpb25cbiAgICovXG4gIGFzeW5jIGdldCAoKSA6IFByb21pc2U8QXBwbGljYXRpb24+IHtcbiAgICBjb25zdCByZXEgPSBuZXcgcHJvdG8uQXBwbGljYXRpb25JZGVudGlmaWVyKClcbiAgICByZXEuc2V0QXBwSWQodGhpcy5hcHBJRClcblxuICAgIGNvbnN0IGFwcCA9IGF3YWl0IHRoaXMuZXhlYyh0aGlzLmNsaWVudC5nZXRBcHBsaWNhdGlvbiwgcmVxKVxuICAgIGFwcC5wYXlsb2FkRm9ybWF0ID0gYXBwLnBheWxvYWRGb3JtYXQgfHwgXCJjdXN0b21cIlxuXG4gICAgcmV0dXJuIGFwcFxuICB9XG5cbiAgLyoqXG4gICAqIENoYW5nZSB0aGUgcGF5bG9hZCBmb3JtYXQgb2YgdGhlIGFwcGxpY2F0aW9uLlxuICAgKi9cbiAgYXN5bmMgc2V0UGF5bG9hZEZvcm1hdCAoZm9ybWF0IDogUGF5bG9hZEZvcm1hdCkgOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnNldCh7XG4gICAgICBwYXlsb2FkRm9ybWF0OiBmb3JtYXQsXG4gICAgfSlcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGN1c3RvbSBwYXlsb2FkIGZ1bmN0aW9ucyBvZiB0aGUgYXBwbGljYXRpb24gYW5kIHNldCB0aGUgZm9ybWF0XG4gICAqIHRvIGN1c3RvbS5cbiAgICovXG4gIGFzeW5jIHNldEN1c3RvbVBheWxvYWRGdW5jdGlvbnMgKGZucyA6IFBheWxvYWRGdW5jdGlvbnMgPSB7fSkgOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnNldCh7XG4gICAgICBwYXlsb2FkRm9ybWF0OiBcImN1c3RvbVwiLFxuICAgICAgLi4uZm5zLFxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSByZWdpc3Rlck9uSm9pbkFjY2Vzc0tleSBvciByZW1vdmUgaXQuXG4gICAqL1xuICBhc3luYyBzZXRSZWdpc3Rlck9uSm9pbkFjY2Vzc0tleSAodG8gOiBzdHJpbmcpIDogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5zZXQoe1xuICAgICAgcmVnaXN0ZXJPbkpvaW5BY2Nlc3NLZXk6IHRvLFxuICAgIH0pXG4gIH1cblxuICAvKipcbiAgICogVW5yZWdpc3RlciB0aGUgYXBwbGljYXRpb24gZnJvbSB0aGUgaGFuZGxlci5cbiAgICovXG4gIGFzeW5jIHVucmVnaXN0ZXIgKCkgOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXEgPSBuZXcgcHJvdG8uQXBwbGljYXRpb25JZGVudGlmaWVyKClcbiAgICByZXEuc2V0QXBwSWQodGhpcy5hcHBJRClcbiAgICByZXR1cm4gdGhpcy5leGVjKHRoaXMuY2xpZW50LmRlbGV0ZUFwcGxpY2F0aW9uLCByZXEpXG4gIH1cblxuICAvKiogQHByaXZhdGUgKi9cbiAgYXN5bmMgc2V0ICh1cGRhdGVzIDogQXBwbGljYXRpb25VcGRhdGVzID0ge30pIDogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcmVxID0gbmV3IHByb3RvLkFwcGxpY2F0aW9uKClcblxuICAgIHJlcS5zZXRBcHBJZCh0aGlzLmFwcElEKVxuXG4gICAgaWYgKFwicGF5bG9hZEZvcm1hdFwiIGluIHVwZGF0ZXMpIHtcbiAgICAgIHJlcS5zZXRQYXlsb2FkRm9ybWF0KHVwZGF0ZXMucGF5bG9hZEZvcm1hdClcbiAgICB9XG5cbiAgICBpZiAoXCJyZWdpc3Rlck9uSm9pbkFjY2Vzc0tleVwiIGluIHVwZGF0ZXMpIHtcbiAgICAgIHJlcS5zZXRSZWdpc3Rlck9uSm9pbkFjY2Vzc0tleSh1cGRhdGVzLnJlZ2lzdGVyT25Kb2luQWNjZXNzS2V5KVxuICAgIH1cblxuICAgIGlmIChcImRlY29kZXJcIiBpbiB1cGRhdGVzKSB7XG4gICAgICByZXEuc2V0RGVjb2Rlcih1cGRhdGVzLmRlY29kZXIpXG4gICAgfVxuXG4gICAgaWYgKFwiY29udmVydGVyXCIgaW4gdXBkYXRlcykge1xuICAgICAgcmVxLnNldENvbnZlcnRlcih1cGRhdGVzLmNvbnZlcnRlcilcbiAgICB9XG5cbiAgICBpZiAoXCJ2YWxpZGF0b3JcIiBpbiB1cGRhdGVzKSB7XG4gICAgICByZXEuc2V0VmFsaWRhdG9yKHVwZGF0ZXMudmFsaWRhdG9yKVxuICAgIH1cblxuICAgIGlmIChcImVuY29kZXJcIiBpbiB1cGRhdGVzKSB7XG4gICAgICByZXEuc2V0RW5jb2Rlcih1cGRhdGVzLmVuY29kZXIpXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuZXhlYyh0aGlzLmNsaWVudC5zZXRBcHBsaWNhdGlvbiwgcmVxKVxuICB9XG5cbiAgLyoqXG4gICAqIExpc3QgdGhlIGRldmljZXMgb2YgdGhlIGFwcGxpY2F0aW9uXG4gICAqL1xuICBhc3luYyBkZXZpY2VzICgpIDogUHJvbWlzZTxEZXZpY2VbXT4ge1xuICAgIGNvbnN0IHJlcSA9IG5ldyBwcm90by5BcHBsaWNhdGlvbklkZW50aWZpZXIoKVxuICAgIHJlcS5zZXRBcHBJZCh0aGlzLmFwcElEKVxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZXhlYyh0aGlzLmNsaWVudC5nZXREZXZpY2VzRm9yQXBwbGljYXRpb24sIHJlcSlcbiAgICByZXR1cm4gcmVzLmRldmljZXNMaXN0Lm1hcChub3JtYWxpemUpXG4gIH1cblxuICAvKipcbiAgICogUmVnaXN0ZXIgYSBkZXZpY2UgaW4gdGhlIGFwcGxpY2F0aW9uLlxuICAgKi9cbiAgYXN5bmMgcmVnaXN0ZXJEZXZpY2UgKGRldklEIDogc3RyaW5nLCBkZXZpY2UgOiBEZXZpY2VVcGRhdGVzKSA6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLnNldERldmljZShkZXZJRCwgZGV2aWNlKVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgZGV2aWNlIHNwZWNpZmllZCBieSB0aGUgZGV2SURcbiAgICovXG4gIGFzeW5jIGRldmljZSAoZGV2SUQgOiBzdHJpbmcpIDogUHJvbWlzZTxEZXZpY2U+IHtcbiAgICBjb25zdCByZXEgPSBuZXcgcHJvdG8uRGV2aWNlSWRlbnRpZmllcigpXG4gICAgcmVxLnNldEFwcElkKHRoaXMuYXBwSUQpXG4gICAgcmVxLnNldERldklkKGRldklEKVxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuZXhlYyh0aGlzLmNsaWVudC5nZXREZXZpY2UsIHJlcSlcbiAgICByZXR1cm4gbm9ybWFsaXplKHJlcylcbiAgfVxuXG4gIC8qKiBAcHJpdmF0ZSAqL1xuICBhc3luYyBzZXREZXZpY2UgKGRldklEIDogc3RyaW5nLCBkZXZpY2UgOiBEZXZpY2VVcGRhdGVzKSA6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHJlcSA9IHRoaXMuZGV2aWNlUmVxdWVzdChkZXZJRCwgZGV2aWNlKVxuICAgIHJldHVybiB0aGlzLmV4ZWModGhpcy5jbGllbnQuc2V0RGV2aWNlLCByZXEpXG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHRoZSBkZXZpY2Ugc3BlY2lmaWVkIGJ5IHRoZSBkZXZJRCB3aXRoIHRoZSBzcGVjaWZpZWQgdXBkYXRlc1xuICAgKi9cbiAgYXN5bmMgdXBkYXRlRGV2aWNlIChkZXZJRCA6IHN0cmluZywgdXBkYXRlcyA6IERldmljZVVwZGF0ZXMpIDogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZGV2aWNlID0gYXdhaXQgdGhpcy5kZXZpY2UoZGV2SUQpXG4gICAgY29uc3QgcmVxID0gdGhpcy5kZXZpY2VSZXF1ZXN0KGRldklELCB7IC4uLmRldmljZSwgLi4udXBkYXRlcyB9KVxuICAgIHJldHVybiB0aGlzLmV4ZWModGhpcy5jbGllbnQuc2V0RGV2aWNlLCByZXEpXG4gIH1cblxuICAvKipcbiAgICogRGVsZXRlIHRoZSBzcGVjaWZpZWQgZGV2aWNlLlxuICAgKi9cbiAgYXN5bmMgZGVsZXRlRGV2aWNlIChkZXZJRCA6IHN0cmluZykgOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXEgPSBuZXcgcHJvdG8uRGV2aWNlSWRlbnRpZmllcigpXG4gICAgcmVxLnNldEFwcElkKHRoaXMuYXBwSUQpXG4gICAgcmVxLnNldERldklkKGRldklEKVxuICAgIHJldHVybiB0aGlzLmV4ZWModGhpcy5jbGllbnQuZGVsZXRlRGV2aWNlLCByZXEpXG4gIH1cblxuICAvKiogQHByaXZhdGUgKi9cbiAgZGV2aWNlUmVxdWVzdCAoZGV2SUQgOiBzdHJpbmcsIGRldmljZSA6IERldmljZVVwZGF0ZXMgPSB7fSkgOiBhbnkge1xuICAgIGNvbnN0IHJlcSA9IG5ldyBwcm90by5EZXZpY2UoKVxuICAgIHJlcS5zZXRBcHBJZCh0aGlzLmFwcElEKVxuICAgIHJlcS5zZXREZXZJZChkZXZJRClcblxuICAgIGlmIChcImRlc2NyaXB0aW9uXCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0RGVzY3JpcHRpb24oZGV2aWNlLmRlc2NyaXB0aW9uKVxuICAgIH1cblxuICAgIGlmIChcImxhdGl0dWRlXCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0TGF0aXR1ZGUoZGV2aWNlLmxhdGl0dWRlKVxuICAgIH1cblxuICAgIGlmIChcImxvbmdpdHVkZVwiIGluIGRldmljZSkge1xuICAgICAgcmVxLnNldExvbmdpdHVkZShkZXZpY2UubG9uZ2l0dWRlKVxuICAgIH1cblxuICAgIGlmIChcImFsdGl0dWRlXCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0QWx0aXR1ZGUoZGV2aWNlLmFsdGl0dWRlKVxuICAgIH1cblxuICAgIGlmIChcImF0dHJpYnV0ZXNcIiBpbiBkZXZpY2UpIHtcbiAgICAgIE9iamVjdC5rZXlzKGRldmljZS5hdHRyaWJ1dGVzKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgcmVxLmdldEF0dHJpYnV0ZXNNYXAoKS5zZXQoa2V5LCBkZXZpY2UuYXR0cmlidXRlc1trZXldKVxuICAgICAgfSlcbiAgICB9XG5cbiAgICByZXEuc2V0TG9yYXdhbkRldmljZSh0aGlzLmxvcmF3YW5EZXZpY2VSZXF1ZXN0KGRldklELCBkZXZpY2UpKVxuXG4gICAgcmV0dXJuIHJlcVxuICB9XG5cbiAgLyoqIEBwcml2YXRlICovXG4gIGxvcmF3YW5EZXZpY2VSZXF1ZXN0IChkZXZJRCA6IHN0cmluZywgZGV2aWNlIDogTG9yYXdhbkRldmljZVVwZGF0ZXMgPSB7fSkgOiBhbnkge1xuICAgIGNvbnN0IHJlcSA9IG5ldyBsb3Jhd2FuLkRldmljZSgpXG5cbiAgICByZXEuc2V0QXBwSWQodGhpcy5hcHBJRClcbiAgICByZXEuc2V0RGV2SWQoZGV2SUQpXG5cbiAgICBpZiAoXCJhcHBFdWlcIiBpbiBkZXZpY2UpIHtcbiAgICAgIHJlcS5zZXRBcHBFdWkobmV3IFVpbnQ4QXJyYXkobmV3IEJ1ZmZlcihkZXZpY2UuYXBwRXVpLCBcImhleFwiKSkpXG4gICAgfVxuXG4gICAgaWYgKFwiZGV2RXVpXCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0RGV2RXVpKG5ldyBVaW50OEFycmF5KG5ldyBCdWZmZXIoZGV2aWNlLmRldkV1aSwgXCJoZXhcIikpKVxuICAgIH1cblxuICAgIGlmIChcImRldkFkZHJcIiBpbiBkZXZpY2UpIHtcbiAgICAgIHJlcS5zZXREZXZBZGRyKG5ldyBVaW50OEFycmF5KG5ldyBCdWZmZXIoZGV2aWNlLmRldkFkZHIsIFwiaGV4XCIpKSlcbiAgICB9XG5cbiAgICBpZiAoXCJud2tTS2V5XCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0TndrU0tleShuZXcgVWludDhBcnJheShuZXcgQnVmZmVyKGRldmljZS5ud2tTS2V5LCBcImhleFwiKSkpXG4gICAgfVxuXG4gICAgaWYgKFwiYXBwU0tleVwiIGluIGRldmljZSkge1xuICAgICAgcmVxLnNldEFwcFNLZXkobmV3IFVpbnQ4QXJyYXkobmV3IEJ1ZmZlcihkZXZpY2UuYXBwU0tleSwgXCJoZXhcIikpKVxuICAgIH1cblxuICAgIGlmIChcImFwcEtleVwiIGluIGRldmljZSkge1xuICAgICAgcmVxLnNldEFwcEtleShuZXcgVWludDhBcnJheShuZXcgQnVmZmVyKGRldmljZS5hcHBLZXksIFwiaGV4XCIpKSlcbiAgICB9XG5cbiAgICBpZiAoXCJmQ250VXBcIiBpbiBkZXZpY2UpIHtcbiAgICAgIHJlcS5zZXRGQ250VXAoZGV2aWNlLmZDbnRVcClcbiAgICB9XG5cbiAgICBpZiAoXCJmQ250RG93blwiIGluIGRldmljZSkge1xuICAgICAgcmVxLnNldEZDbnREb3duKGRldmljZS5mQ250RG93bilcbiAgICB9XG5cbiAgICBpZiAoXCJkaXNhYmxlRkNudENoZWNrXCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0RGlzYWJsZUZDbnRDaGVjayhkZXZpY2UuZGlzYWJsZUZDbnRDaGVjaylcbiAgICB9XG5cbiAgICBpZiAoXCJ1c2VzMzJCaXRGQ250XCIgaW4gZGV2aWNlKSB7XG4gICAgICByZXEuc2V0VXNlczMyQml0RkNudChkZXZpY2UudXNlczMyQml0RkNudClcbiAgICB9XG5cbiAgICByZXR1cm4gcmVxXG4gIH1cbn1cbiJdfQ==