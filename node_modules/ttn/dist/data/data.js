"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DataClient = undefined;

var _stringify = require("babel-runtime/core-js/json/stringify");

var _stringify2 = _interopRequireDefault(_stringify);

var _toConsumableArray2 = require("babel-runtime/helpers/toConsumableArray");

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _slicedToArray2 = require("babel-runtime/helpers/slicedToArray");

var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);

var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _createClass2 = require("babel-runtime/helpers/createClass");

var _createClass3 = _interopRequireDefault(_createClass2);

var _sourceMapSupport2 = require("source-map-support");

var _events = require("events");

var _events2 = _interopRequireDefault(_events);

var _mqtt = require("mqtt");

var _mqtt2 = _interopRequireDefault(_mqtt);

var _debug = require("../utils/debug");

var _debug2 = _interopRequireDefault(_debug);

var _topic = require("./topic");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

(0, _sourceMapSupport2.install)(); // Copyright Â© 2017 The Things Network
// Use of this source code is governed by the MIT license that can be found in the LICENSE file.

/**
 * DataClient is a client for The Things Network data API.
 */
var DataClient = exports.DataClient = function () {

  /**
   * Creates a new DataClient and opens the MQTT connection.
   */


  /** @private */
  function DataClient(appID, appAccessKey, mqttAddress) {
    (0, _classCallCheck3.default)(this, DataClient);

    this.appID = appID;
    this.emitter = new _events2.default();

    var _mqttAddress$split = mqttAddress.split(":"),
        _mqttAddress$split2 = (0, _slicedToArray3.default)(_mqttAddress$split, 2),
        host = _mqttAddress$split2[0],
        _mqttAddress$split2$ = _mqttAddress$split2[1],
        port = _mqttAddress$split2$ === undefined ? "1883" : _mqttAddress$split2$;

    (0, _debug2.default)("connecting to mqtt host `%s` on port %d, using username `%s`", host, parseInt(port), appID);

    this.mqtt = _mqtt2.default.connect({
      host: host,
      port: parseInt(port),
      username: appID,
      password: appAccessKey
    });

    this.mqtt.on("error", this.onError.bind(this));
    this.mqtt.on("connect", this.onConnect.bind(this));
    this.mqtt.on("message", this.onMessage.bind(this));
    this.mqtt.on("reconnect", this.onReconnect.bind(this));
    this.mqtt.on("close", this.onClose.bind(this));
  }

  /**
   * Close the mqtt connection
   *
   * @param force - passing it to true will close the client right away, without waiting for the in-flight messages to be acked
   * @param callback - will be called when the client is closed
   */


  /** @private */

  /** @private */


  (0, _createClass3.default)(DataClient, [{
    key: "close",
    value: function close() {
      var force = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;
      var callback = arguments[1];

      (0, _debug2.default)("closing mqtt client");
      return this.mqtt.end(force, callback);
    }

    /**
     * Same as close (for backwards compatibility).
     */

  }, {
    key: "end",
    value: function end(force, callback) {
      return this.close(force, callback);
    }

    /**
     * Starts listening to events.
     *
     * Possible events are:
     *
     * - `uplink` (or `message`): Messages sent by the devices to the appliction.
     * - `activation`: An alias for the `activations` (see `event`)
     * - `event` (or `device`): Events that happen to devices. You can filter on
     *   the events by adding more parameters. For instance:
     *   - `downlink/scheduled`
     *   - `downlink/sent`
     *   - `activations`
     *   - `create`
     *   - `update`
     *   - `delete`
     *   - `down/acks`
     *   - `up/errors`
     *   - `down/errors`
     *   - `activations/errors`
     *
     * See [The MQTT API Reference](https://www.thethingsnetwork.org/docs/applications/mqtt/api.html)
     * for more information about these events and what their payloads look like.
     *
     * @param event - The name of the event to listen to.
     * @param [devID] - An optional devID. If not passed will subscribe to the event for all devices.
     * @param [name|field] - The name of the field to listen for on uplink or the event for device events.
     * @param callback - The callback to call when the event occurs.
     *
     * @example
     * // listens to all uplinks from all devices
     * client.on("uplink", function (devID, message) {})
     *
     * @example
     * // listens to all uplinks from the device with id `foo`
     * client.on("uplink", "foo", function (devID, message) {})
     *
     * @example
     * // listens to all device events for all devices
     * client.on("event", function (devID, message) {})
     *
     * @example
     * // listens to all device events for device with id `foo`
     * client.on("event", "foo", function (devID, message) {})
     *
     * @example
     * // listens to the `downlink/scheduled` events for device with id `foo`
     * client.on("event", "foo", "downlink/scheduled", function (devID, message) {})
     *
     * @example
     * // listens to the `downlink/scheduled` events for all devices
     * client.on("event", "+", "downlink/scheduled", function (devID, message) {})
     */

  }, {
    key: "on",
    value: function on(event) {
      for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        args[_key - 1] = arguments[_key];
      }

      return this.toggle.apply(this, [true, event].concat(args));
    }

    /**
     * Stop listening to events.
     * The argument structure is the same as for `on()`.
     */

  }, {
    key: "off",
    value: function off(event) {
      for (var _len2 = arguments.length, args = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {
        args[_key2 - 1] = arguments[_key2];
      }

      return this.toggle.apply(this, [false, event].concat(args));
    }

    /**
     * @private
     * Toggles the subscription matching to the received arguments
     *
     */

  }, {
    key: "toggle",
    value: function toggle(on, event) {
      for (var _len3 = arguments.length, args = Array(_len3 > 2 ? _len3 - 2 : 0), _key3 = 2; _key3 < _len3; _key3++) {
        args[_key3 - 2] = arguments[_key3];
      }

      if (args.length < 1) {
        throw new Error("Need at least one argument to on");
      }

      var rest = args.slice(0);

      var cb = rest.pop();

      var t = null;

      switch (event) {
        case "uplink":
        case "message":
          t = _topic.uplinkTopic.apply(undefined, (0, _toConsumableArray3.default)(rest));
          break;
        case "device":
        case "event":
        case "events":
          t = _topic.eventTopic.apply(undefined, (0, _toConsumableArray3.default)(rest));
          break;
        case "activation":
          var _rest = (0, _slicedToArray3.default)(rest, 1),
              _rest$ = _rest[0],
              _devID = _rest$ === undefined ? _topic.wildcard : _rest$;

          t = (0, _topic.eventTopic)(_devID, "activations");
          break;
        case "error":
        case "connect":
        case "reconnect":
        case "close":
          this.emitter.on(event, cb);
          return;
      }

      if (t === null) {
        throw new Error("Could not build topic");
      }

      if (on) {
        this.subscribe(t, cb);
      } else {
        this.unsubscribe(t, cb);
      }
    }

    /**
     * Send a downlink message to the device with the specified device ID.
     *
     * @param devID - The device ID of the device to send the downlink to.
     * @param payload - The raw payload as a Buffer, an Array of numbers, a hex string  or an object of payload fields.
     * @param port - The port to send the message on.
     * @param confirmed - Set to true for confirmed downlink.
     * @param schedule - Set to the scheduling you want to use (first, last or replace).
     */

  }, {
    key: "send",
    value: function send(devID, payload) {
      var port = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 1;
      var confirmed = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
      var schedule = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : "replace";

      var t = (0, _topic.downlinkTopic)(this.appID, devID);
      var message = {
        port: port,
        confirmed: confirmed,
        schedule: schedule
      };

      if (Array.isArray(payload)) {
        message.payload_raw = new Buffer(payload).toString("base64");
      } else if (payload instanceof Buffer) {
        message.payload_raw = payload.toString("base64");
      } else if (typeof payload === "string") {
        message.payload_raw = new Buffer(payload, "hex").toString("base64");
      } else {
        message.payload_fields = payload;
      }

      (0, _debug2.default)("publishing message to %s: %O", t, message);

      this.mqtt.publish(t, (0, _stringify2.default)(message));
    }

    /**
     * @private
     * `onError` is called whenever there's an error in the MQTT client.
     */

  }, {
    key: "onError",
    value: function onError(err) {
      (0, _debug2.default)("mqtt client received error: %s", err);
      this.emitter.emit("error", err);
    }

    /**
     * @private
     * `onConnect` is called whenever the MQTT client (re-)connects.
     */

  }, {
    key: "onConnect",
    value: function onConnect(ack) {
      (0, _debug2.default)("mqtt client connected");
      this.emitter.emit("connect", ack);
    }

    /**
     * @private
     * `onReconnect` is called whenever the MQTT client starts reconnecting.
     */

  }, {
    key: "onReconnect",
    value: function onReconnect() {
      (0, _debug2.default)("mqtt client reconnecting");
      this.emitter.emit("reconnect", undefined);
    }

    /**
     * @private
     * `onClose` is called after the MQTT disconnects.
     */

  }, {
    key: "onClose",
    value: function onClose() {
      (0, _debug2.default)("mqtt client disconnected");
      this.emitter.emit("close", undefined);
    }

    /**
     * @private
     * `onMessage` is called when a new message is received from any subscription.
     */

  }, {
    key: "onMessage",
    value: function onMessage(topic, message) {
      var _this = this;

      var payload = JSON.parse(message.toString());

      if (payload && typeof payload.payload_raw === "string") {
        payload.payload_raw = new Buffer(payload.payload_raw, "base64");
      }

      (0, _debug2.default)("received message on topic `%s`: %O", topic, payload);

      var dev = (0, _topic.devID)(topic);
      (0, _topic.validWildcards)(topic).forEach(function (topic) {
        return _this.emitter.emit(topic, dev, payload);
      });
    }

    /**
     * @private
     * `subscribe` subscribes the mqtt client to the specified topic and hooks up
     * the callback in the event emitter.
     */

  }, {
    key: "subscribe",
    value: function subscribe(topic, cb) {
      (0, _debug2.default)("subscribing to messages on topic `%s`", topic);
      this.mqtt.subscribe(topic);
      this.emitter.on(topic, cb);
    }

    /**
     * @private
     * `unsubscribe` unsubscribes the mqtt client from the specified topic and
     * removes the callback from the event emitter.
     */

  }, {
    key: "unsubscribe",
    value: function unsubscribe(topic, cb) {
      (0, _debug2.default)("unsubscribing from messages on topic `%s`", topic);
      this.mqtt.unsubscribe(topic);
      this.emitter.removeListener(topic, cb);
    }
  }]);
  return DataClient;
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kYXRhL2RhdGEuanMiXSwibmFtZXMiOlsiRGF0YUNsaWVudCIsImFwcElEIiwiYXBwQWNjZXNzS2V5IiwibXF0dEFkZHJlc3MiLCJlbWl0dGVyIiwic3BsaXQiLCJob3N0IiwicG9ydCIsInBhcnNlSW50IiwibXF0dCIsImNvbm5lY3QiLCJ1c2VybmFtZSIsInBhc3N3b3JkIiwib24iLCJvbkVycm9yIiwiYmluZCIsIm9uQ29ubmVjdCIsIm9uTWVzc2FnZSIsIm9uUmVjb25uZWN0Iiwib25DbG9zZSIsImZvcmNlIiwiY2FsbGJhY2siLCJlbmQiLCJjbG9zZSIsImV2ZW50IiwiYXJncyIsInRvZ2dsZSIsImxlbmd0aCIsIkVycm9yIiwicmVzdCIsImNiIiwicG9wIiwidCIsImRldklEIiwic3Vic2NyaWJlIiwidW5zdWJzY3JpYmUiLCJwYXlsb2FkIiwiY29uZmlybWVkIiwic2NoZWR1bGUiLCJtZXNzYWdlIiwiQXJyYXkiLCJpc0FycmF5IiwicGF5bG9hZF9yYXciLCJCdWZmZXIiLCJ0b1N0cmluZyIsInBheWxvYWRfZmllbGRzIiwicHVibGlzaCIsImVyciIsImVtaXQiLCJhY2siLCJ1bmRlZmluZWQiLCJ0b3BpYyIsIkpTT04iLCJwYXJzZSIsImRldiIsImZvckVhY2giLCJyZW1vdmVMaXN0ZW5lciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFLQTs7OztBQUNBOzs7O0FBRUE7Ozs7QUFFQTs7OzttQ0FWQTtBQUNBOztBQThCQTs7O0lBR2FBLFUsV0FBQUEsVTs7QUFVWDs7Ozs7QUFOQTtBQVNBLHNCQUFhQyxLQUFiLEVBQTZCQyxZQUE3QixFQUFvREMsV0FBcEQsRUFBaUY7QUFBQTs7QUFDL0UsU0FBS0YsS0FBTCxHQUFhQSxLQUFiO0FBQ0EsU0FBS0csT0FBTCxHQUFlLHNCQUFmOztBQUYrRSw2QkFJL0NELFlBQVlFLEtBQVosQ0FBa0IsR0FBbEIsQ0FKK0M7QUFBQTtBQUFBLFFBSXZFQyxJQUp1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LENBQThCO0FBQUEsZUFBUyxNQUFLbkQsT0FBTCxDQUFhNEMsSUFBYixDQUFrQkcsS0FBbEIsRUFBeUJHLEdBQXpCLEVBQThCbEIsT0FBOUIsQ0FBVDtBQUFBLE9BQTlCO0FBQ0Q7O0FBRUQ7Ozs7Ozs7OzhCQUtXZSxLLEVBQWdCckIsRSxFQUFzQjtBQUMvQywyQkFBTSx1Q0FBTixFQUErQ3FCLEtBQS9DO0FBQ0EsV0FBSzFDLElBQUwsQ0FBVXlCLFNBQVYsQ0FBb0JpQixLQUFwQjtBQUNBLFdBQUsvQyxPQUFMLENBQWFTLEVBQWIsQ0FBZ0JzQyxLQUFoQixFQUF1QnJCLEVBQXZCO0FBQ0Q7O0FBRUQ7Ozs7Ozs7O2dDQUthcUIsSyxFQUFnQnJCLEUsRUFBc0I7QUFDakQsMkJBQU0sMkNBQU4sRUFBbURxQixLQUFuRDtBQUNBLFdBQUsxQyxJQUFMLENBQVUwQixXQUFWLENBQXNCZ0IsS0FBdEI7QUFDQSxXQUFLL0MsT0FBTCxDQUFhb0QsY0FBYixDQUE0QkwsS0FBNUIsRUFBbUNyQixFQUFuQztBQUNEIiwiZmlsZSI6ImRhdGEuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgwqkgMjAxNyBUaGUgVGhpbmdzIE5ldHdvcmtcbi8vIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IHRoZSBNSVQgbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLlxuXG4vLyBAZmxvd1xuXG5pbXBvcnQgRXZlbnRFbWl0dGVyIGZyb20gXCJldmVudHNcIlxuaW1wb3J0IG1xdHQgZnJvbSBcIm1xdHRcIlxuXG5pbXBvcnQgZGVidWcgZnJvbSBcIi4uL3V0aWxzL2RlYnVnXCJcblxuaW1wb3J0IHsgZGV2SUQsIHdpbGRjYXJkLCB1cGxpbmtUb3BpYywgZXZlbnRUb3BpYywgZG93bmxpbmtUb3BpYywgdmFsaWRXaWxkY2FyZHMgfSBmcm9tIFwiLi90b3BpY1wiXG5cbnR5cGUgRGV2aWNlSUQgPSBzdHJpbmdcbnR5cGUgQ29ubmFjayA9IHtcbiAgc2Vzc2lvblByZXNlbnQgOiBib29sZWFuLFxufVxuXG50eXBlIFBheWxvYWRBcnJheSA9IEFycmF5PG51bWJlcj5cbnR5cGUgUGF5bG9hZFJhdyA9IEJ1ZmZlclxudHlwZSBQYXlsb2FkRmllbGRzID0geyBbc3RyaW5nXTogYW55IH1cbnR5cGUgU2NoZWR1bGUgPSBcInJlcGxhY2VcIiB8IFwiZmlyc3RcIiB8IFwibGFzdFwiXG5cbnR5cGUgRG93bmxpbmtNZXNzYWdlID0ge1xuICBwb3J0IDogbnVtYmVyLFxuICBwYXlsb2FkX3Jhdz8gOiBzdHJpbmcsXG4gIHBheWxvYWRfZmllbGRzPyA6IFBheWxvYWRGaWVsZHMsXG4gIGNvbmZpcm1lZD8gOiBib29sZWFuLFxuICBzY2hlZHVsZT8gOiBTY2hlZHVsZSxcbn1cblxuXG4vKipcbiAqIERhdGFDbGllbnQgaXMgYSBjbGllbnQgZm9yIFRoZSBUaGluZ3MgTmV0d29yayBkYXRhIEFQSS5cbiAqL1xuZXhwb3J0IGNsYXNzIERhdGFDbGllbnQge1xuICAvKiogQHByaXZhdGUgKi9cbiAgYXBwSUQgOiBzdHJpbmdcblxuICAvKiogQHByaXZhdGUgKi9cbiAgZW1pdHRlciA6IEV2ZW50RW1pdHRlclxuXG4gIC8qKiBAcHJpdmF0ZSAqL1xuICBtcXR0IDogYW55XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBuZXcgRGF0YUNsaWVudCBhbmQgb3BlbnMgdGhlIE1RVFQgY29ubmVjdGlvbi5cbiAgICovXG4gIGNvbnN0cnVjdG9yIChhcHBJRCA6IHN0cmluZywgYXBwQWNjZXNzS2V5IDogc3RyaW5nLCBtcXR0QWRkcmVzcyA6IHN0cmluZykgOiB2b2lkIHtcbiAgICB0aGlzLmFwcElEID0gYXBwSURcbiAgICB0aGlzLmVtaXR0ZXIgPSBuZXcgRXZlbnRFbWl0dGVyKClcblxuICAgIGNvbnN0IFsgaG9zdCwgcG9ydCA9IFwiMTg4M1wiIF0gPSBtcXR0QWRkcmVzcy5zcGxpdChcIjpcIilcblxuICAgIGRlYnVnKFwiY29ubmVjdGluZyB0byBtcXR0IGhvc3QgYCVzYCBvbiBwb3J0ICVkLCB1c2luZyB1c2VybmFtZSBgJXNgXCIsIGhvc3QsIHBhcnNlSW50KHBvcnQpLCBhcHBJRClcblxuICAgIHRoaXMubXF0dCA9IG1xdHQuY29ubmVjdCh7XG4gICAgICBob3N0LFxuICAgICAgcG9ydDogcGFyc2VJbnQocG9ydCksXG4gICAgICB1c2VybmFtZTogYXBwSUQsXG4gICAgICBwYXNzd29yZDogYXBwQWNjZXNzS2V5LFxuICAgIH0pXG5cbiAgICB0aGlzLm1xdHQub24oXCJlcnJvclwiLCB0aGlzLm9uRXJyb3IuYmluZCh0aGlzKSlcbiAgICB0aGlzLm1xdHQub24oXCJjb25uZWN0XCIsIHRoaXMub25Db25uZWN0LmJpbmQodGhpcykpXG4gICAgdGhpcy5tcXR0Lm9uKFwibWVzc2FnZVwiLCB0aGlzLm9uTWVzc2FnZS5iaW5kKHRoaXMpKVxuICAgIHRoaXMubXF0dC5vbihcInJlY29ubmVjdFwiLCB0aGlzLm9uUmVjb25uZWN0LmJpbmQodGhpcykpXG4gICAgdGhpcy5tcXR0Lm9uKFwiY2xvc2VcIiwgdGhpcy5vbkNsb3NlLmJpbmQodGhpcykpXG4gIH1cblxuICAvKipcbiAgICogQ2xvc2UgdGhlIG1xdHQgY29ubmVjdGlvblxuICAgKlxuICAgKiBAcGFyYW0gZm9yY2UgLSBwYXNzaW5nIGl0IHRvIHRydWUgd2lsbCBjbG9zZSB0aGUgY2xpZW50IHJpZ2h0IGF3YXksIHdpdGhvdXQgd2FpdGluZyBmb3IgdGhlIGluLWZsaWdodCBtZXNzYWdlcyB0byBiZSBhY2tlZFxuICAgKiBAcGFyYW0gY2FsbGJhY2sgLSB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBjbGllbnQgaXMgY2xvc2VkXG4gICAqL1xuICBjbG9zZSAoZm9yY2UgOiA/Ym9vbGVhbiA9IGZhbHNlLCBjYWxsYmFjayA6ID9GdW5jdGlvbikge1xuICAgIGRlYnVnKFwiY2xvc2luZyBtcXR0IGNsaWVudFwiKVxuICAgIHJldHVybiB0aGlzLm1xdHQuZW5kKGZvcmNlLCBjYWxsYmFjaylcbiAgfVxuXG4gIC8qKlxuICAgKiBTYW1lIGFzIGNsb3NlIChmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkpLlxuICAgKi9cbiAgZW5kIChmb3JjZSA6ID9ib29sZWFuLCBjYWxsYmFjayA6ID9GdW5jdGlvbikge1xuICAgIHJldHVybiB0aGlzLmNsb3NlKGZvcmNlLCBjYWxsYmFjaylcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydHMgbGlzdGVuaW5nIHRvIGV2ZW50cy5cbiAgICpcbiAgICogUG9zc2libGUgZXZlbnRzIGFyZTpcbiAgICpcbiAgICogLSBgdXBsaW5rYCAob3IgYG1lc3NhZ2VgKTogTWVzc2FnZXMgc2VudCBieSB0aGUgZGV2aWNlcyB0byB0aGUgYXBwbGljdGlvbi5cbiAgICogLSBgYWN0aXZhdGlvbmA6IEFuIGFsaWFzIGZvciB0aGUgYGFjdGl2YXRpb25zYCAoc2VlIGBldmVudGApXG4gICAqIC0gYGV2ZW50YCAob3IgYGRldmljZWApOiBFdmVudHMgdGhhdCBoYXBwZW4gdG8gZGV2aWNlcy4gWW91IGNhbiBmaWx0ZXIgb25cbiAgICogICB0aGUgZXZlbnRzIGJ5IGFkZGluZyBtb3JlIHBhcmFtZXRlcnMuIEZvciBpbnN0YW5jZTpcbiAgICogICAtIGBkb3dubGluay9zY2hlZHVsZWRgXG4gICAqICAgLSBgZG93bmxpbmsvc2VudGBcbiAgICogICAtIGBhY3RpdmF0aW9uc2BcbiAgICogICAtIGBjcmVhdGVgXG4gICAqICAgLSBgdXBkYXRlYFxuICAgKiAgIC0gYGRlbGV0ZWBcbiAgICogICAtIGBkb3duL2Fja3NgXG4gICAqICAgLSBgdXAvZXJyb3JzYFxuICAgKiAgIC0gYGRvd24vZXJyb3JzYFxuICAgKiAgIC0gYGFjdGl2YXRpb25zL2Vycm9yc2BcbiAgICpcbiAgICogU2VlIFtUaGUgTVFUVCBBUEkgUmVmZXJlbmNlXShodHRwczovL3d3dy50aGV0aGluZ3NuZXR3b3JrLm9yZy9kb2NzL2FwcGxpY2F0aW9ucy9tcXR0L2FwaS5odG1sKVxuICAgKiBmb3IgbW9yZSBpbmZvcm1hdGlvbiBhYm91dCB0aGVzZSBldmVudHMgYW5kIHdoYXQgdGhlaXIgcGF5bG9hZHMgbG9vayBsaWtlLlxuICAgKlxuICAgKiBAcGFyYW0gZXZlbnQgLSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQgdG8gbGlzdGVuIHRvLlxuICAgKiBAcGFyYW0gW2RldklEXSAtIEFuIG9wdGlvbmFsIGRldklELiBJZiBub3QgcGFzc2VkIHdpbGwgc3Vic2NyaWJlIHRvIHRoZSBldmVudCBmb3IgYWxsIGRldmljZXMuXG4gICAqIEBwYXJhbSBbbmFtZXxmaWVsZF0gLSBUaGUgbmFtZSBvZiB0aGUgZmllbGQgdG8gbGlzdGVuIGZvciBvbiB1cGxpbmsgb3IgdGhlIGV2ZW50IGZvciBkZXZpY2UgZXZlbnRzLlxuICAgKiBAcGFyYW0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdG8gY2FsbCB3aGVuIHRoZSBldmVudCBvY2N1cnMuXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqIC8vIGxpc3RlbnMgdG8gYWxsIHVwbGlua3MgZnJvbSBhbGwgZGV2aWNlc1xuICAgKiBjbGllbnQub24oXCJ1cGxpbmtcIiwgZnVuY3Rpb24gKGRldklELCBtZXNzYWdlKSB7fSlcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogLy8gbGlzdGVucyB0byBhbGwgdXBsaW5rcyBmcm9tIHRoZSBkZXZpY2Ugd2l0aCBpZCBgZm9vYFxuICAgKiBjbGllbnQub24oXCJ1cGxpbmtcIiwgXCJmb29cIiwgZnVuY3Rpb24gKGRldklELCBtZXNzYWdlKSB7fSlcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogLy8gbGlzdGVucyB0byBhbGwgZGV2aWNlIGV2ZW50cyBmb3IgYWxsIGRldmljZXNcbiAgICogY2xpZW50Lm9uKFwiZXZlbnRcIiwgZnVuY3Rpb24gKGRldklELCBtZXNzYWdlKSB7fSlcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogLy8gbGlzdGVucyB0byBhbGwgZGV2aWNlIGV2ZW50cyBmb3IgZGV2aWNlIHdpdGggaWQgYGZvb2BcbiAgICogY2xpZW50Lm9uKFwiZXZlbnRcIiwgXCJmb29cIiwgZnVuY3Rpb24gKGRldklELCBtZXNzYWdlKSB7fSlcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICogLy8gbGlzdGVucyB0byB0aGUgYGRvd25saW5rL3NjaGVkdWxlZGAgZXZlbnRzIGZvciBkZXZpY2Ugd2l0aCBpZCBgZm9vYFxuICAgKiBjbGllbnQub24oXCJldmVudFwiLCBcImZvb1wiLCBcImRvd25saW5rL3NjaGVkdWxlZFwiLCBmdW5jdGlvbiAoZGV2SUQsIG1lc3NhZ2UpIHt9KVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiAvLyBsaXN0ZW5zIHRvIHRoZSBgZG93bmxpbmsvc2NoZWR1bGVkYCBldmVudHMgZm9yIGFsbCBkZXZpY2VzXG4gICAqIGNsaWVudC5vbihcImV2ZW50XCIsIFwiK1wiLCBcImRvd25saW5rL3NjaGVkdWxlZFwiLCBmdW5jdGlvbiAoZGV2SUQsIG1lc3NhZ2UpIHt9KVxuICAgKi9cbiAgb24gKGV2ZW50IDogc3RyaW5nLCAuLi5hcmdzIDogQXJyYXk8Kj4pIDogdm9pZCB7XG4gICAgcmV0dXJuIHRoaXMudG9nZ2xlKHRydWUsIGV2ZW50LCAuLi5hcmdzKVxuICB9XG5cbiAgLyoqXG4gICAqIFN0b3AgbGlzdGVuaW5nIHRvIGV2ZW50cy5cbiAgICogVGhlIGFyZ3VtZW50IHN0cnVjdHVyZSBpcyB0aGUgc2FtZSBhcyBmb3IgYG9uKClgLlxuICAgKi9cbiAgb2ZmIChldmVudCA6IHN0cmluZywgLi4uYXJncyA6IEFycmF5PCo+KSA6IHZvaWQge1xuICAgIHJldHVybiB0aGlzLnRvZ2dsZShmYWxzZSwgZXZlbnQsIC4uLmFyZ3MpXG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICogVG9nZ2xlcyB0aGUgc3Vic2NyaXB0aW9uIG1hdGNoaW5nIHRvIHRoZSByZWNlaXZlZCBhcmd1bWVudHNcbiAgICpcbiAgICovXG4gIHRvZ2dsZSAob24gOiBib29sZWFuLCBldmVudCA6IHN0cmluZywgLi4uYXJncyA6IEFycmF5PCo+KSA6IHZvaWQge1xuICAgIGlmIChhcmdzLmxlbmd0aCA8IDEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIk5lZWQgYXQgbGVhc3Qgb25lIGFyZ3VtZW50IHRvIG9uXCIpXG4gICAgfVxuXG4gICAgY29uc3QgWyAuLi5yZXN0IF0gPSBhcmdzXG4gICAgY29uc3QgY2IgPSByZXN0LnBvcCgpXG5cbiAgICBsZXQgdCA9IG51bGxcblxuICAgIHN3aXRjaCAoZXZlbnQpIHtcbiAgICBjYXNlIFwidXBsaW5rXCI6XG4gICAgY2FzZSBcIm1lc3NhZ2VcIjpcbiAgICAgIHQgPSB1cGxpbmtUb3BpYyguLi5yZXN0KVxuICAgICAgYnJlYWtcbiAgICBjYXNlIFwiZGV2aWNlXCI6XG4gICAgY2FzZSBcImV2ZW50XCI6XG4gICAgY2FzZSBcImV2ZW50c1wiOlxuICAgICAgdCA9IGV2ZW50VG9waWMoLi4ucmVzdClcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBcImFjdGl2YXRpb25cIjpcbiAgICAgIGNvbnN0IFsgZGV2SUQgPSB3aWxkY2FyZCBdID0gcmVzdFxuICAgICAgdCA9IGV2ZW50VG9waWMoZGV2SUQsIFwiYWN0aXZhdGlvbnNcIilcbiAgICAgIGJyZWFrXG4gICAgY2FzZSBcImVycm9yXCI6XG4gICAgY2FzZSBcImNvbm5lY3RcIjpcbiAgICBjYXNlIFwicmVjb25uZWN0XCI6XG4gICAgY2FzZSBcImNsb3NlXCI6XG4gICAgICB0aGlzLmVtaXR0ZXIub24oZXZlbnQsIGNiKVxuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKHQgPT09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNvdWxkIG5vdCBidWlsZCB0b3BpY1wiKVxuICAgIH1cblxuICAgIGlmIChvbikge1xuICAgICAgdGhpcy5zdWJzY3JpYmUodCwgY2IpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudW5zdWJzY3JpYmUodCwgY2IpXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlbmQgYSBkb3dubGluayBtZXNzYWdlIHRvIHRoZSBkZXZpY2Ugd2l0aCB0aGUgc3BlY2lmaWVkIGRldmljZSBJRC5cbiAgICpcbiAgICogQHBhcmFtIGRldklEIC0gVGhlIGRldmljZSBJRCBvZiB0aGUgZGV2aWNlIHRvIHNlbmQgdGhlIGRvd25saW5rIHRvLlxuICAgKiBAcGFyYW0gcGF5bG9hZCAtIFRoZSByYXcgcGF5bG9hZCBhcyBhIEJ1ZmZlciwgYW4gQXJyYXkgb2YgbnVtYmVycywgYSBoZXggc3RyaW5nICBvciBhbiBvYmplY3Qgb2YgcGF5bG9hZCBmaWVsZHMuXG4gICAqIEBwYXJhbSBwb3J0IC0gVGhlIHBvcnQgdG8gc2VuZCB0aGUgbWVzc2FnZSBvbi5cbiAgICogQHBhcmFtIGNvbmZpcm1lZCAtIFNldCB0byB0cnVlIGZvciBjb25maXJtZWQgZG93bmxpbmsuXG4gICAqIEBwYXJhbSBzY2hlZHVsZSAtIFNldCB0byB0aGUgc2NoZWR1bGluZyB5b3Ugd2FudCB0byB1c2UgKGZpcnN0LCBsYXN0IG9yIHJlcGxhY2UpLlxuICAgKi9cbiAgc2VuZCAoZGV2SUQgOiBEZXZpY2VJRCwgcGF5bG9hZCA6IFBheWxvYWRBcnJheSB8IFBheWxvYWRSYXcgfCBTdHJpbmcgfCBQYXlsb2FkRmllbGRzLCBwb3J0IDogbnVtYmVyID0gMSwgY29uZmlybWVkIDogYm9vbGVhbiA9IGZhbHNlLCBzY2hlZHVsZSA6IFNjaGVkdWxlID0gXCJyZXBsYWNlXCIpIHtcbiAgICBjb25zdCB0ID0gZG93bmxpbmtUb3BpYyh0aGlzLmFwcElELCBkZXZJRClcbiAgICBjb25zdCBtZXNzYWdlIDogRG93bmxpbmtNZXNzYWdlID0ge1xuICAgICAgcG9ydCxcbiAgICAgIGNvbmZpcm1lZCxcbiAgICAgIHNjaGVkdWxlLFxuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KHBheWxvYWQpKSB7XG4gICAgICBtZXNzYWdlLnBheWxvYWRfcmF3ID0gbmV3IEJ1ZmZlcihwYXlsb2FkKS50b1N0cmluZyhcImJhc2U2NFwiKVxuICAgIH0gZWxzZSBpZiAocGF5bG9hZCBpbnN0YW5jZW9mIEJ1ZmZlcikge1xuICAgICAgbWVzc2FnZS5wYXlsb2FkX3JhdyA9IHBheWxvYWQudG9TdHJpbmcoXCJiYXNlNjRcIilcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBwYXlsb2FkID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBtZXNzYWdlLnBheWxvYWRfcmF3ID0gbmV3IEJ1ZmZlcihwYXlsb2FkLCBcImhleFwiKS50b1N0cmluZyhcImJhc2U2NFwiKVxuICAgIH0gZWxzZSB7XG4gICAgICBtZXNzYWdlLnBheWxvYWRfZmllbGRzID0gcGF5bG9hZFxuICAgIH1cblxuICAgIGRlYnVnKFwicHVibGlzaGluZyBtZXNzYWdlIHRvICVzOiAlT1wiLCB0LCBtZXNzYWdlKVxuXG4gICAgdGhpcy5tcXR0LnB1Ymxpc2godCwgSlNPTi5zdHJpbmdpZnkobWVzc2FnZSkpXG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICogYG9uRXJyb3JgIGlzIGNhbGxlZCB3aGVuZXZlciB0aGVyZSdzIGFuIGVycm9yIGluIHRoZSBNUVRUIGNsaWVudC5cbiAgICovXG4gIG9uRXJyb3IgKGVyciA6IGFueSkgOiB2b2lkIHtcbiAgICBkZWJ1ZyhcIm1xdHQgY2xpZW50IHJlY2VpdmVkIGVycm9yOiAlc1wiLCBlcnIpXG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoXCJlcnJvclwiLCBlcnIpXG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICogYG9uQ29ubmVjdGAgaXMgY2FsbGVkIHdoZW5ldmVyIHRoZSBNUVRUIGNsaWVudCAocmUtKWNvbm5lY3RzLlxuICAgKi9cbiAgb25Db25uZWN0IChhY2sgOiBDb25uYWNrKSA6IHZvaWQge1xuICAgIGRlYnVnKFwibXF0dCBjbGllbnQgY29ubmVjdGVkXCIpXG4gICAgdGhpcy5lbWl0dGVyLmVtaXQoXCJjb25uZWN0XCIsIGFjaylcbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBgb25SZWNvbm5lY3RgIGlzIGNhbGxlZCB3aGVuZXZlciB0aGUgTVFUVCBjbGllbnQgc3RhcnRzIHJlY29ubmVjdGluZy5cbiAgICovXG4gIG9uUmVjb25uZWN0ICgpIDogdm9pZCB7XG4gICAgZGVidWcoXCJtcXR0IGNsaWVudCByZWNvbm5lY3RpbmdcIilcbiAgICB0aGlzLmVtaXR0ZXIuZW1pdChcInJlY29ubmVjdFwiLCB1bmRlZmluZWQpXG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICogYG9uQ2xvc2VgIGlzIGNhbGxlZCBhZnRlciB0aGUgTVFUVCBkaXNjb25uZWN0cy5cbiAgICovXG4gIG9uQ2xvc2UgKCkgOiB2b2lkIHtcbiAgICBkZWJ1ZyhcIm1xdHQgY2xpZW50IGRpc2Nvbm5lY3RlZFwiKVxuICAgIHRoaXMuZW1pdHRlci5lbWl0KFwiY2xvc2VcIiwgdW5kZWZpbmVkKVxuICB9XG5cbiAgLyoqXG4gICAqIEBwcml2YXRlXG4gICAqIGBvbk1lc3NhZ2VgIGlzIGNhbGxlZCB3aGVuIGEgbmV3IG1lc3NhZ2UgaXMgcmVjZWl2ZWQgZnJvbSBhbnkgc3Vic2NyaXB0aW9uLlxuICAgKi9cbiAgb25NZXNzYWdlICh0b3BpYyA6IHN0cmluZywgbWVzc2FnZSA6IGFueSkgOiB2b2lkIHtcbiAgICBjb25zdCBwYXlsb2FkID0gSlNPTi5wYXJzZShtZXNzYWdlLnRvU3RyaW5nKCkpXG5cbiAgICBpZiAocGF5bG9hZCAmJiB0eXBlb2YgcGF5bG9hZC5wYXlsb2FkX3JhdyA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcGF5bG9hZC5wYXlsb2FkX3JhdyA9IG5ldyBCdWZmZXIocGF5bG9hZC5wYXlsb2FkX3JhdywgXCJiYXNlNjRcIilcbiAgICB9XG5cbiAgICBkZWJ1ZyhcInJlY2VpdmVkIG1lc3NhZ2Ugb24gdG9waWMgYCVzYDogJU9cIiwgdG9waWMsIHBheWxvYWQpXG5cbiAgICBjb25zdCBkZXYgPSBkZXZJRCh0b3BpYylcbiAgICB2YWxpZFdpbGRjYXJkcyh0b3BpYykuZm9yRWFjaCh0b3BpYyA9PiB0aGlzLmVtaXR0ZXIuZW1pdCh0b3BpYywgZGV2LCBwYXlsb2FkKSlcbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBgc3Vic2NyaWJlYCBzdWJzY3JpYmVzIHRoZSBtcXR0IGNsaWVudCB0byB0aGUgc3BlY2lmaWVkIHRvcGljIGFuZCBob29rcyB1cFxuICAgKiB0aGUgY2FsbGJhY2sgaW4gdGhlIGV2ZW50IGVtaXR0ZXIuXG4gICAqL1xuICBzdWJzY3JpYmUgKHRvcGljIDogc3RyaW5nLCBjYiA6IEZ1bmN0aW9uKSA6IHZvaWQge1xuICAgIGRlYnVnKFwic3Vic2NyaWJpbmcgdG8gbWVzc2FnZXMgb24gdG9waWMgYCVzYFwiLCB0b3BpYylcbiAgICB0aGlzLm1xdHQuc3Vic2NyaWJlKHRvcGljKVxuICAgIHRoaXMuZW1pdHRlci5vbih0b3BpYywgY2IpXG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICogYHVuc3Vic2NyaWJlYCB1bnN1YnNjcmliZXMgdGhlIG1xdHQgY2xpZW50IGZyb20gdGhlIHNwZWNpZmllZCB0b3BpYyBhbmRcbiAgICogcmVtb3ZlcyB0aGUgY2FsbGJhY2sgZnJvbSB0aGUgZXZlbnQgZW1pdHRlci5cbiAgICovXG4gIHVuc3Vic2NyaWJlICh0b3BpYyA6IHN0cmluZywgY2IgOiBGdW5jdGlvbikgOiB2b2lkIHtcbiAgICBkZWJ1ZyhcInVuc3Vic2NyaWJpbmcgZnJvbSBtZXNzYWdlcyBvbiB0b3BpYyBgJXNgXCIsIHRvcGljKVxuICAgIHRoaXMubXF0dC51bnN1YnNjcmliZSh0b3BpYylcbiAgICB0aGlzLmVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIodG9waWMsIGNiKVxuICB9XG59XG4iXX0=