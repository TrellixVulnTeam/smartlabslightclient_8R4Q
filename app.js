var serialPort=require('serialport'),
   Web3=require('web3');

//check for geth connection
if (typeof web3 !== 'undefined') {
  web3 = new Web3(web3.currentProvider);
} else {
  // set the provider you want from Web3.providers
  web3 = new Web3(new Web3.providers.HttpProvider("http://10.1.1.3:8543"));
  console.log("IPC:coneection established to account "+web3.eth.accounts);
}

ABIarray=[{"constant":true,"inputs":[],"name":"Turbhigh","outputs":[{"name":"","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"Country","type":"bytes32"}],"name":"showflag","outputs":[{"name":"j","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"Colow","outputs":[{"name":"","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"index","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"x11","type":"uint16"},{"name":"x21","type":"uint16"},{"name":"x31","type":"uint16"},{"name":"x41","type":"uint16"}],"name":"compare","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"Country","type":"bytes32"},{"name":"Location","type":"bytes32"},{"name":"deviceID","type":"bytes32"},{"name":"x11","type":"uint16"},{"name":"x21","type":"uint16"},{"name":"x31","type":"uint16"},{"name":"x41","type":"uint16"}],"name":"save","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"Co2low","outputs":[{"name":"","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"Co2high","outputs":[{"name":"","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"Country","type":"bytes32"},{"name":"Location","type":"bytes32"},{"name":"deviceID","type":"bytes32"}],"name":"retrievedata","outputs":[{"name":"x","type":"bytes32"},{"name":"y","type":"uint16"},{"name":"z","type":"uint16"},{"name":"k","type":"uint16"},{"name":"j","type":"uint16"},{"name":"f","type":"bytes32[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"Turblow","outputs":[{"name":"","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"PHlow","outputs":[{"name":"","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"Cohigh","outputs":[{"name":"","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"message","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"PHhigh","outputs":[{"name":"","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"retrievestandards","outputs":[{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"},{"name":"","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"bytes32"}],"name":"cdata","outputs":[{"name":"flag","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"data","outputs":[{"name":"Country","type":"bytes32"},{"name":"Location","type":"bytes32"},{"name":"deviceID","type":"bytes32"},{"name":"CO","type":"uint16"},{"name":"CO2","type":"uint16"},{"name":"Turbidity","type":"uint16"},{"name":"PH","type":"uint16"}],"payable":false,"stateMutability":"view","type":"function"}];

contractAddress="0x4c1fe53fe9547349d3cfab6f752d6e12df3c50db";

bytedata="6060604052341561000f57600080fd5b610ee18061001e6000396000f3006060604052600436106100f1576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063016dd30c146100f65780631b93097a146101275780631ea88bff14610166578063335932fc146101975780635a388f2c146101ce57806379b02baf146102345780637e295487146102c1578063a3a7f02e146102f2578063b2166dad14610323578063b4eb4ec114610404578063bd2d068314610435578063c0679aa414610466578063d1e8507b14610497578063d8bbd327146104d6578063db86c5ff14610507578063edc399b2146105a1578063f0ba8440146105e0575b600080fd5b341561010157600080fd5b610109610679565b604051808261ffff1661ffff16815260200191505060405180910390f35b341561013257600080fd5b61014c60048080356000191690602001909190505061067e565b604051808215151515815260200191505060405180910390f35b341561017157600080fd5b6101796106b3565b604051808261ffff1661ffff16815260200191505060405180910390f35b34156101a257600080fd5b6101b860048080359060200190919050506106b8565b6040518082815260200191505060405180910390f35b34156101d957600080fd5b61021a600480803561ffff1690602001909190803561ffff1690602001909190803561ffff1690602001909190803561ffff169060200190919050506106dc565b604051808215151515815260200191505060405180910390f35b341561023f57600080fd5b6102a7600480803560001916906020019091908035600019169060200190919080356000191690602001909190803561ffff1690602001909190803561ffff1690602001909190803561ffff1690602001909190803561ffff1690602001909190505061091f565b604051808215151515815260200191505060405180910390f35b34156102cc57600080fd5b6102d4610ae8565b604051808261ffff1661ffff16815260200191505060405180910390f35b34156102fd57600080fd5b610305610aed565b604051808261ffff1661ffff16815260200191505060405180910390f35b341561032e57600080fd5b6103626004808035600019169060200190919080356000191690602001909190803560001916906020019091905050610af3565b6040518087600019166000191681526020018661ffff1661ffff1681526020018561ffff1661ffff1681526020018461ffff1661ffff1681526020018361ffff1661ffff16815260200180602001828103825283818151815260200191508051906020019060200280838360005b838110156103eb5780820151818401526020810190506103d0565b5050505090500197505050505050505060405180910390f35b341561040f57600080fd5b610417610cbf565b604051808261ffff1661ffff16815260200191505060405180910390f35b341561044057600080fd5b610448610cc4565b604051808261ffff1661ffff16815260200191505060405180910390f35b341561047157600080fd5b610479610cc9565b604051808261ffff1661ffff16815260200191505060405180910390f35b34156104a257600080fd5b6104b86004808035906020019091905050610cce565b60405180826000191660001916815260200191505060405180910390f35b34156104e157600080fd5b6104e9610cf2565b604051808261ffff1661ffff16815260200191505060405180910390f35b341561051257600080fd5b61051a610cf7565b604051808961ffff1661ffff1681526020018861ffff1661ffff1681526020018761ffff1661ffff1681526020018661ffff1661ffff1681526020018561ffff1661ffff1681526020018461ffff1661ffff1681526020018361ffff1661ffff1681526020018261ffff1661ffff1681526020019850505050505050505060405180910390f35b34156105ac57600080fd5b6105c6600480803560001916906020019091905050610d2e565b604051808215151515815260200191505060405180910390f35b34156105eb57600080fd5b6106016004808035906020019091905050610d59565b604051808860001916600019168152602001876000191660001916815260200186600019166000191681526020018561ffff1661ffff1681526020018461ffff1661ffff1681526020018361ffff1661ffff1681526020018261ffff1661ffff16815260200197505050505050505060405180910390f35b600581565b600060026000836000191660001916815260200190815260200160002060000160009054906101000a900460ff169050919050565b600981565b6001818154811015156106c757fe5b90600052602060002090016000915090505481565b60008060019050600080816106f19190610dd3565b50600961ffff168661ffff1610806107115750602361ffff168661ffff16115b8015610721575060008661ffff16115b1561077a576000805480600101828161073a9190610dff565b916000526020600020900160007f434f00000000000000000000000000000000000000000000000000000000000090919091509060001916905550600090505b60fa61ffff168561ffff16108061079a575061015e61ffff168561ffff16115b80156107aa575060008561ffff16115b1561080357600080548060010182816107c39190610dff565b916000526020600020900160007f434f32000000000000000000000000000000000000000000000000000000000090919091509060001916905550600090505b600061ffff168461ffff1610806108225750600561ffff168461ffff16115b8015610832575060008461ffff16115b1561088b576000805480600101828161084b9190610dff565b916000526020600020900160007f547572626964697479000000000000000000000000000000000000000000000090919091509060001916905550600090505b600661ffff168361ffff1610806108aa5750600961ffff168361ffff16115b80156108ba575060008361ffff16115b1561091357600080548060010182816108d39190610dff565b916000526020600020900160007f504800000000000000000000000000000000000000000000000000000000000090919091509060001916905550600090505b80915050949350505050565b60008061092e868686866106dc565b90508660036000600180549050815260200190815260200160002060020181600019169055508860036000600180549050815260200190815260200160002060000181600019169055508760036000600180549050815260200190815260200160002060010181600019169055508560036000600180549050815260200190815260200160002060030160006101000a81548161ffff021916908361ffff1602179055508460036000600180549050815260200190815260200160002060030160026101000a81548161ffff021916908361ffff1602179055508360036000600180549050815260200190815260200160002060030160046101000a81548161ffff021916908361ffff1602179055508260036000600180549050815260200190815260200160002060030160066101000a81548161ffff021916908361ffff16021790555080600260008b6000191660001916815260200190815260200160002060000160006101000a81548160ff02191690831515021790555060018054806001018281610abe9190610e2b565b91600052602060002090016000600180549050909190915055506001915050979650505050505050565b60fa81565b61015e81565b6000806000806000610b03610e57565b6000879650600090505b600180549050811015610c3c578960001916600360008381526020019081526020016000206000015460001916148015610b6457508860001916600360008381526020019081526020016000206001015460001916145b8015610b8d57508760001916600360008381526020019081526020016000206002015460001916145b15610c2f576003600082815260200190815260200160002060030160009054906101000a900461ffff1695506003600082815260200190815260200160002060030160029054906101000a900461ffff1694506003600082815260200190815260200160002060030160049054906101000a900461ffff1693506003600082815260200190815260200160002060030160069054906101000a900461ffff1692505b8080600101915050610b0d565b610c48868686866106dc565b508686868686600080805480602002602001604051908101604052809291908181526020018280548015610c9f57602002820191906000526020600020905b81546000191681526020019060010190808311610c87575b505050505090509650965096509650965096505093975093979195509350565b600081565b600681565b602381565b600081815481101515610cdd57fe5b90600052602060002090016000915090505481565b600981565b6000806000806000806000806009602360fa61015e6000600560066009975097509750975097509750975097509091929394959697565b60026020528060005260406000206000915090508060000160009054906101000a900460ff16905081565b60036020528060005260406000206000915090508060000154908060010154908060020154908060030160009054906101000a900461ffff16908060030160029054906101000a900461ffff16908060030160049054906101000a900461ffff16908060030160069054906101000a900461ffff16905087565b815481835581811511610dfa57818360005260206000209182019101610df99190610e6b565b5b505050565b815481835581811511610e2657818360005260206000209182019101610e259190610e6b565b5b505050565b815481835581811511610e5257818360005260206000209182019101610e519190610e90565b5b505050565b602060405190810160405280600081525090565b610e8d91905b80821115610e89576000816000905550600101610e71565b5090565b90565b610eb291905b80821115610eae576000816000905550600101610e96565b5090565b905600a165627a7a723058207222b50693796a6c539f605db7d56e772be14934f17080ae7965b3fa0e15c24d0029";

myContract=web3.eth.contract(ABIarray).at(contractAddress);
var dataarray= [];

//read data from serial port
function readSerial(){
	
var myPort=new serialPort('/dev/ttyACM0',{baudRate:9600, parser:serialPort.parsers.readline});

myPort.on('open',function(){
	console.log('Serial Port Open');

	myPort.on('data',function(data){   
		dataarray.push(data.toString().split('\r\n'));
		console.log(dataarray[0][0]+"  "+dataarray[0][1]+"  "+dataarray[0][2]+"  "+dataarray[0][3]);
		test();
});
	
});

}
readSerial();
function execute()
{
	console.log("Transaction Starts here");
	console.log("Standard CO:"+myContract.Colow());
	console.log("Standard CO2:"+myContract.Co2low());
	console.log("Standard PH:"+myContract.PHlow());
	console.log("Standard Turbidity:"+myContract.Turblow());
	try
	{
	myContract.save.sendTransaction("Switzerland","Zurich","MQ7",dataarray[0][1].toString(),dataarray[0][0].toString(),dataarray[0][2].toString(),dataarray[0][3].toString(),{from:web3.eth.accounts[0], gas:300000},function(err,res){
    console.log("transaction sent is:"+res);   
    });
	}
	catch(e)
	{
	 console.log(e);
	}
	readSerial();
}	
function test()
{
	if(dataarray.length>=1)
		{
			execute();
			console.log("execute");
			dataarray.length=0;
		}
}

